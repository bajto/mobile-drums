<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Drum Pad</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0d10">
<style>
:root{
  --bg:#0b0d10; --text:#e6edf3; --muted:#9aa4ad;
  --pad:#1b1f24; --pad-active:#2d333b; --accent:#4aa3ff;
  --topbar-h:52px;
  --size-min:84px; --size-vw:28vw; --size-max:160px;
  --btn-bg:#12161b; --btn-br:#2b3138; --btn-glow:rgba(74,163,255,.35);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-tap-highlight-color:transparent; touch-action:manipulation;}
body,#app{min-height:100svh}

/* Topbar */
.topbar{position:fixed;top:0;left:0;right:0;z-index:90;height:var(--topbar-h);
  display:flex;align-items:center;gap:.6rem;padding:0 .6rem; background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));}
.title{font-weight:800;letter-spacing:.4px;margin-left:.2rem}
.badge{font-size:.85rem;color:var(--muted);padding:.1rem .4rem;border:1px solid var(--btn-br);border-radius:.5rem;background:#0e1116}

/* Buttons */
.btn, select, input[type="text"]{
  appearance:none;cursor:pointer;font-weight:700;color:var(--text);
  background:var(--btn-bg);border:1px solid var(--btn-br);border-radius:.8rem;
  padding:.5rem .8rem;display:inline-flex;align-items:center;gap:.45rem;
  box-shadow:0 0 0 1px rgba(255,255,255,.02) inset, 0 4px 16px rgba(0,0,0,.32);
}
.btn:active{transform:scale(.98)}
.btn.ghost{background:transparent}
.btn.primary{background:#142231;border-color:#356a92}
.btn.toggle{position:relative}
.btn.toggle[data-on="1"]{outline:2px solid var(--accent); box-shadow:0 0 0 3px rgba(74,163,255,.13)}

body.theme-neon{
  --bg:#070910; --text:#e9f6ff; --muted:#9cc7ff;
  --pad:#0b1020; --pad-active:#111a33; --accent:#00e5ff;
  --btn-bg:#0a1121; --btn-br:#123154; --btn-glow:rgba(0,229,255,.45);
}
body.theme-neon .btn, body.theme-neon select{
  box-shadow:0 0 10px var(--btn-glow), 0 8px 24px rgba(0,0,0,.35), inset 0 2px 0 rgba(0,0,0,.55);
  text-shadow:0 0 6px rgba(0,229,255,.25);
}
body.theme-neon .btn.toggle[data-on="1"]{outline:2px solid var(--accent); box-shadow:0 0 14px var(--btn-glow), 0 0 0 3px rgba(0,229,255,.15)}

/* Stage/layout */
#stage{position:fixed; top:calc(var(--topbar-h) + 4px); left:0; right:0; bottom:6px; padding:.8rem; overflow:hidden; touch-action:manipulation;}
.grid{display:grid;gap:.8rem;
  grid-template-columns:repeat(auto-fit,minmax(clamp(var(--size-min), var(--size-vw), var(--size-max)),1fr));
  grid-auto-rows:minmax(clamp(72px,16vh,180px),1fr); align-content:start}
.canvas{position:relative}
.canvas .pad{position:absolute;touch-action:none;transform-origin:center center}

/* Pads */
.pad{
  background:var(--pad);border:1px solid #2b3138;border-radius:12px;
  display:flex;align-items:center;justify-content:center;text-align:center;
  padding:.45rem;user-select:none;-webkit-user-select:none;font-weight:800;letter-spacing:.3px;
  box-shadow:0 2px 0 rgba(0,0,0,.5) inset,0 6px 18px rgba(0,0,0,.25);
  touch-action:none;font-size:16px; color:#111; outline-offset:0; position:relative;
}
.pad .labelInner{pointer-events:none}
.pad.active{background:var(--pad-active);outline:2px solid var(--accent);box-shadow:0 0 0 4px rgba(74,163,255,.15),0 10px 28px rgba(0,0,0,.4) inset;transform:scale(.99)}
.pad.dragging{opacity:.95;outline:2px dashed var(--accent)}
.shape-round{border-radius:12px}
.shape-oval{border-radius:9999px}
.shape-circle{border-radius:9999px}

/* gear */
.pad .gear{display:none; position:absolute; right:6px; top:6px; width:22px; height:22px; border-radius:999px;
  border:1px solid var(--btn-br); background:var(--btn-bg); align-items:center; justify-content:center; font-size:14px; line-height:1}
.pad.selected .gear{display:flex}

/* Menu */
#menuPanel{position:fixed;inset:0;z-index:100;display:none;background:rgba(0,0,0,.72);backdrop-filter:saturate(1.2) blur(6px);padding:64px 14px 14px;color:var(--text)}
.menu-card{margin:0 auto;max-width:780px;background:#0e1116;border:1px solid #2b3138;border-radius:1rem; padding:.9rem}
.menu-section{border-top:1px solid #212832;margin-top:.7rem;padding-top:.7rem}
.menu-row{display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap}
.menu-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.7rem}

/* Layout bar */
#layoutBar{position:fixed;left:50%;transform:translateX(-50%); bottom:10px; z-index:95; display:none; gap:.5rem}

/* Edit panel */
#editPanel{position:fixed;left:8px;right:8px;bottom:8px;z-index:96;display:none;background:#0b0e14cc;border:1px solid #1f2633;border-radius:1rem;padding:.5rem .6rem;backdrop-filter: blur(6px)}
#editPanel.at-top{top:8px;bottom:auto}
#editPanel .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
.pad.selected{outline:2px solid var(--accent)}
.handle{position:absolute;width:16px;height:16px;background:#fff;border:2px solid #0007;border-radius:50%;box-shadow:0 2px 6px #0008;touch-action:none}
.h-nw{left:-10px;top:-10px;cursor:nwse-resize}
.h-ne{right:-10px;top:-10px;cursor:nesw-resize}
.h-sw{left:-10px;bottom:-10px;cursor:nesw-resize}
.h-se{right:-10px;bottom:-10px;cursor:nwse-resize}
.h-rot{left:50%;top:-36px;transform:translateX(-50%);width:20px;height:20px;cursor:grab}

/* Icon btn */
.iconbtn{appearance:none;cursor:pointer;border:1px solid var(--btn-br);border-radius:.8rem;background:var(--btn-bg);color:var(--text);padding:.5rem .8rem;display:flex;align-items:center;gap:.4rem}
.icon{width:18px;height:2px;background:currentColor;position:relative;display:inline-block}
.icon::before,.icon::after{content:"";position:absolute;left:0;right:0;height:2px;background:currentColor}
.icon::before{top:-6px}.icon::after{top:6px}

/* small tweak */
.canvas .pad{box-sizing:border-box}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <button id="menuBtn" class="iconbtn" title="Menu"><span class="icon" aria-hidden="true"></span></button>
    <div class="title">Drum Pad</div>
    <div style="margin-left:auto" class="badge">BPM: <span id="bpmTopVal">100</span></div>
  </div>

  <div id="stage" class="grid"></div>

  <div id="layoutBar">
    <button id="layoutSave" class="btn primary">Zapisz</button>
    <button id="layoutCancel" class="btn ghost">Anuluj</button>
    <button id="layoutProps" class="btn">Cechy…</button>
  </div>

  <div id="menuPanel" aria-hidden="true">
    <div class="menu-card">
      <div class="menu-section"><div class="menu-row"><strong>Ustawienia</strong><span class="badge">wybierz i „OK”</span></div></div>

      <div class="menu-section">
        <div class="menu-row">
          <div>Zestaw</div>
          <div>
            <select id="kitSelect" class="btn"></select>
            <button id="customBtn" class="btn">Własne…</button>
          </div>
        </div>
        <div class="menu-row">
          <div>Układ</div>
          <div>
            <button id="layoutStart" class="btn">START</button>
            <button id="layoutUseBtn" class="btn toggle" data-on="0">Użyj mojego układu</button>
          </div>
        </div>
      </div>

      <div class="menu-section">
        <div class="menu-row">
          <div>Metronom</div>
          <div>
            <button id="metroBtn" class="btn toggle" data-on="0">Metro</button>
            <label class="badge">BPM: <span id="bpmVal">100</span></label>
            <input id="bpm" type="range" min="40" max="220" step="1" value="100">
          </div>
        </div>
        <div class="menu-row">
          <div>Neon</div>
          <div><button id="themeBtn" class="btn toggle" data-on="0">Neon</button></div>
        </div>
        <div class="menu-row">
          <div>Rozmiar padów</div>
          <div><input id="size" type="range" min="80" max="130" step="1" value="100"></div>
        </div>
        <div class="menu-row">
          <div>Głośność</div>
          <div><input id="volume" type="range" min="0" max="1" step="0.01" value="0.9"></div>
        </div>
      </div>

      <div class="menu-actions">
        <button id="menuCancel" class="btn ghost">Anuluj</button>
        <button id="menuOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Panel edycji pada -->
  <div id="editPanel">
    <div class="row">
      <span class="badge">Pad:</span>
      <strong id="epLabel">—</strong>
      <input id="inpLabel" type="text" placeholder="etykieta" class="btn" style="min-width:140px">
      <button id="btnColor" class="btn">Kolor</button>
      <input id="inpColor" type="color" style="display:none">
      <select id="selShape" class="btn">
        <option value="oval">Owal</option>
        <option value="round">Zaokrąglony</option>
        <option value="circle">Okrągły</option>
      </select>
    </div>

    <div class="row">
      <span class="badge">Audio:</span>
      <button id="btnSoundFile" class="btn">Plik…</button>
      <input id="inpSoundFile" type="file" accept="audio/*" style="display:none">
      <button id="btnSoundUrl" class="btn">URL…</button>
      <button id="btnClrSound" class="btn ghost">Usuń przypisanie</button>
    </div>

    <div class="row">
      <span class="badge">Parametry:</span>
      <div style="display:flex;flex-direction:column;gap:.35rem;min-width:240px">
        <label class="btn" style="justify-content:space-between;gap:1rem">Vol&nbsp;<span id="lblGain">1.00 (0 dB)</span></label>
        <input id="rGain" type="range" min="0" max="2" step="0.01" value="1">
        <label class="btn" style="justify-content:space-between;gap:1rem">Semi&nbsp;<span id="lblSemi">0</span></label>
        <input id="rSemi" type="range" min="-24" max="24" step="1" value="0">
        <label class="btn" style="justify-content:space-between;gap:1rem">Atak&nbsp;<span id="lblAtk">0.01 s</span></label>
        <input id="rAtk" type="range" min="0" max="1.5" step="0.01" value="0.01">
        <label class="btn" style="justify-content:space-between;gap:1rem">Zanik&nbsp;<span id="lblDec">0.90 s</span></label>
        <input id="rDec" type="range" min="0.05" max="3" step="0.01" value="0.9">
        <label class="btn" style="justify-content:space-between;gap:1rem">Pan&nbsp;<span id="lblPan">0.0</span></label>
        <input id="rPan" type="range" min="-1" max="1" step="0.1" value="0">
      </div>
    </div>

    <div class="row" style="margin-top:.2rem">
      <label class="btn toggle" id="liveToggle" data-on="1">Odsłuch LIVE</label>
      <button id="btnTest" class="btn">Test</button>
      <button id="btnResetPar" class="btn ghost">Reset parametrów</button>
      <button id="btnEPOk" class="btn primary">OK</button>
    </div>
  </div>
</div>

<script>
/* ==== AUDIO CORE ==== */
let ctx=null, master=null, volumeNode=null;
const vol=document.getElementById('volume');
function initAudio(){ if(ctx) return;
  const AC=window.AudioContext||window.webkitAudioContext;
  ctx=new AC({latencyHint:'interactive'});
  master=ctx.createGain(); volumeNode=ctx.createGain();
  master.connect(volumeNode); volumeNode.connect(ctx.destination);
  volumeNode.gain.value=parseFloat(vol.value);
  try{ const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master); o.start(); o.stop(ctx.currentTime+0.02); }catch{}
}
function startAudio(){ if(!ctx) initAudio(); if(ctx.state!=='running'){ try{ ctx.resume(); }catch{} } }
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') startAudio(); });
const now=()=>ctx?ctx.currentTime+0.01:0;
function noiseBuffer(){ const len=Math.floor(ctx.sampleRate*2.0), b=ctx.createBuffer(1,len,ctx.sampleRate), d=b.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; return b; }
const sharedNoise=(()=>{let _b=null;return()=>_b||(_b=noiseBuffer())})();

/* ==== SYNTHS ==== */
const S={
  kick:(t=now(),par={})=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine';
    const base=160*Math.pow(2,(par.semi||0)/12); o.frequency.setValueAtTime(base,t); o.frequency.exponentialRampToValueAtTime(40,t+(par.dec||.14));
    g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(par.gain??1,t+(par.atk||.01)); g.gain.exponentialRampToValueAtTime(0.001,t+Math.max(.18,(par.dec||.18)));
    o.connect(g).connect(master); o.start(t); o.stop(t+Math.max(.25,(par.dec||.25))); },
  snare:(t=now(),par={})=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
    const g=ctx.createGain(); g.gain.value=par.gain??.6; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+Math.max(.12,(par.dec||.12))); },
  hatClosed:(t=now(),par={})=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000;
    const g=ctx.createGain(); g.gain.value=par.gain??.35; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+Math.max(.06,(par.dec||.06))); },
  hatOpen:(t=now(),par={})=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000;
    const g=ctx.createGain(); g.gain.value=par.gain??.3; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+Math.max(.25,(par.dec||.25))); },
  tomLow:(t=now(),par={})=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine';
    const f=130*Math.pow(2,(par.semi||0)/12); o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(par.gain??.9,t+(par.atk||.01)); g.gain.exponentialRampToValueAtTime(.0001,t+Math.max(.4,(par.dec||.4)));
    o.connect(g).connect(master); o.start(t); o.stop(t+Math.max(.5,(par.dec||.5))); },
  tomHigh:(t=now(),par={})=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine';
    const f=190*Math.pow(2,(par.semi||0)/12); o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(par.gain??.9,t+(par.atk||.01)); g.gain.exponentialRampToValueAtTime(.0001,t+Math.max(.3,(par.dec||.3)));
    o.connect(g).connect(master); o.start(t); o.stop(t+Math.max(.4,(par.dec||.4))); },
  clap:(t=now(),par={})=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const g=ctx.createGain(); g.gain.value=par.gain??.6; src.connect(g).connect(master); src.start(t); src.stop(t+Math.max(.1,(par.dec||.1))); },
  crash:(t=now(),par={})=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000;
    const g=ctx.createGain(); g.gain.value=par.gain??.4; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+Math.max(.7,(par.dec||.7))); },
  ride:(t=now(),par={})=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3500;
    const g=ctx.createGain(); g.gain.value=par.gain??.25; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+Math.max(.6,(par.dec||.6))); },
  rim:(t=now(),par={})=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='square';
    const f=900*Math.pow(2,(par.semi||0)/12); o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(par.gain??.7,t+(par.atk||.005)); g.gain.exponentialRampToValueAtTime(.0001,t+Math.max(.08,(par.dec||.08)));
    o.connect(g).connect(master); o.start(t); o.stop(t+Math.max(.1,(par.dec||.1))); },
  perc:(t=now(),par={})=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='triangle';
    const f=400*Math.pow(2,(par.semi||0)/12); o.frequency.setValueAtTime(f,t);
    g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(par.gain??.8,t+(par.atk||.01)); g.gain.exponentialRampToValueAtTime(0.0001,t+Math.max(.12,(par.dec||.12)));
    o.connect(g).connect(master); o.start(t); o.stop(t+Math.max(.18,(par.dec||.18))); },
  kick808:(t=now(),par={})=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine';
    const startF=80*Math.pow(2,(par.semi||0)/12); o.frequency.setValueAtTime(startF,t); o.frequency.exponentialRampToValueAtTime(38,t+Math.max(.28,(par.dec||.28)));
    g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(par.gain??1,t+(par.atk||.01)); g.gain.exponentialRampToValueAtTime(.0001,t+Math.max(.6,(par.dec||.6)));
    o.connect(g).connect(master); o.start(t); o.stop(t+Math.max(.75,(par.dec||.75))); },
  handpanNote:(freq=220,t=now(),par={})=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); const f=ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=freq; f.Q.value=8;
    const pf = freq*Math.pow(2,(par.semi||0)/12); o.type='sine'; o.frequency.setValueAtTime(pf,t);
    g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(par.gain??.9,t+(par.atk||.01)); g.gain.exponentialRampToValueAtTime(.0001,t+Math.max(.9,(par.dec||.9)));
    o.connect(f).connect(g).connect(master); o.start(t); o.stop(t+Math.max(1.0,(par.dec||1.0))); }
};

/* ==== MAPY NUT ==== */
const HAND={ hand1:220.00, hand2:246.94, hand3:261.63, hand4:293.66, hand5:329.63, hand6:349.23, hand7:392.00, hand8:440.00, hand9:493.88 };
const XYL = {
  xylC4:261.63, xylD4:293.66, xylE4:329.63, xylF4:349.23, xylG4:392.00, xylA4:440.00, xylB4:493.88,
  xylC5:523.25, xylD5:587.33, xylE5:659.25, xylF5:698.46, xylG5:783.99, xylA5:880.00,
  xylCs5:554.37, xylDs5:622.25, xylFs5:739.99, xylGs5:830.61, xylAs5:932.33,
  xylB5:987.77, xylC6:1046.50
};
const LABELS_DIAT13={ xylC4:'C4',xylD4:'D4',xylE4:'E4',xylF4:'F4',xylG4:'G4',xylA4:'A4',xylB4:'H4',xylC5:'C5',xylD5:'D5',xylE5:'E5',xylF5:'F5',xylG5:'G5',xylA5:'A5' };
const LABELS_CHR13={ xylC5:'C',xylCs5:'C#',xylD5:'D',xylDs5:'D#',xylE5:'E',xylF5:'F',xylFs5:'F#',xylG5:'G',xylGs5:'G#',xylA5:'A',xylAs5:'A#',xylB5:'H',xylC6:'C6' };

/* ==== KITS ==== */
const KITS={
  "Standard": ['kick808','snare','hatClosed','hatOpen','tomLow','tomHigh','clap','crash','ride','rim','perc','kick'],
  "Handpan":  ['hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9'],
  "Cymbałki": ['xylC5','xylD5','xylE5','xylF5','xylG5','xylA5','xylB5','xylC6'],
  "Dzwonki diatoniczne (13)": ['xylC4','xylD4','xylE4','xylF4','xylG4','xylA4','xylB4','xylC5','xylD5','xylE5','xylF5','xylG5','xylA5'],
  "Dzwonki chromatyczne (13)": ['xylC5','xylCs5','xylD5','xylDs5','xylE5','xylF5','xylFs5','xylG5','xylGs5','xylA5','xylAs5','xylB5','xylC6']
};
function shapeClass(id){ if(/^hand\d$/.test(id)) return 'shape-oval'; if(['crash','ride','hatClosed','hatOpen'].includes(id)) return 'shape-circle'; return 'shape-round'; }
function colorClass(id){
  if(['kick','kick808'].includes(id)) return 'c-kick';
  if(['snare','clap'].includes(id)) return 'c-snare';
  if(['hatClosed','hatOpen'].includes(id)) return 'c-hats';
  if(['tomHigh','tomLow'].includes(id)) return 'c-toms';
  if(['crash','ride'].includes(id) || /^xyl/.test(id)) return 'c-cym';
  if(/^hand\d$/.test(id)) return 'c-hand';
  return 'c-fun';
}

/* ==== refs & state ==== */
const stage=document.getElementById('stage');
const menuBtn=document.getElementById('menuBtn');
const menuPanel=document.getElementById('menuPanel');
const menuOk=document.getElementById('menuOk');
const menuCancel=document.getElementById('menuCancel');
const kitSelect=document.getElementById('kitSelect');
const layoutStart=document.getElementById('layoutStart');
const layoutUseBtn=document.getElementById('layoutUseBtn');
const sizeEl=document.getElementById('size');
const themeBtn=document.getElementById('themeBtn');
const bpmEl=document.getElementById('bpm');
const bpmVal=document.getElementById('bpmVal');
const bpmTopVal=document.getElementById('bpmTopVal');
const layoutBar=document.getElementById('layoutBar');
const layoutSave=document.getElementById('layoutSave');
const layoutCancel=document.getElementById('layoutCancel');
const layoutProps=document.getElementById('layoutProps');

let currentKit=localStorage.getItem('kitName')||'Standard';
let layoutMode=false;
const positionsKey=()=> 'padPositions:'+currentKit;
const layoutUseKey='useCanvasLayout';
let useCanvasLayout = localStorage.getItem(layoutUseKey)==='1';
let draftPositions=null;
let selectedPadEl=null;
let editPanelVisible=false;

/* helpers */
function isCymbalKit(name){ return name.includes('Cymbałki') || name.includes('Dzwonki'); }
function mergePadCfg(def, over){
  if(!over) return {...def};
  const out = {...def, ...over};
  if(over.color == null) out.color = def.color;
  if(over.shape == null) out.shape = def.shape;
  if(over.rot   == null) out.rot   = def.rot;
  if(!out.par) out.par = def.par ? {...def.par} : {gain:1,semi:0,atk:.01,dec:.2,pan:0};
  return out;
}
function getSavedPositions(){ try{ return JSON.parse(localStorage.getItem(positionsKey())||'{}'); }catch{return{};}}
function setSavedPositions(obj){ localStorage.setItem(positionsKey(), JSON.stringify(obj||{})); }

/* DEFAULT POSITIONS – cymbałki: stały układ poziomych belek (niski dół -> wysoki góra) */
function defaultPositionsForKit(list){
  const out={};
  const isDiat13 = (list.length===13) && list.every(id => (id in LABELS_DIAT13) || id==='xylA5');
  const isChr13  = (list.length===13) && list.every(id => (id in LABELS_CHR13)  || id==='xylC6');
  const isShortXyl = list.length===8 && list.every(id=>/^xyl/.test(id));

  if (isDiat13 || isChr13 || isShortXyl){
    const rot = 0, left = 10, w = 80, h = isShortXyl ? 9 : 6, gap = isShortXyl ? 2 : 1.2;
    const count = list.length;
    const total = count*h + (count-1)*gap;
    const topStart = Math.max(2, 100 - total - 4);

    const pastel = ['#e53935','#fb8c00','#fdd835','#43a047','#1e88e5','#8e24aa','#7e57c2','#26c6da','#90caf9','#66bb6a','#ffb74d','#ef9a9a','#ba68c8'];
    const colWhite = '#f7f8f9', colBlack = '#0f0f10';

    list.forEach((id,i)=>{
      const idxFromBottom = i;
      const top = topStart + (count-1-idxFromBottom)*(h+gap);
      const label = isChr13 ? (LABELS_CHR13[id] || id.toUpperCase())
                            : (isDiat13 ? (LABELS_DIAT13[id] || id.toUpperCase())
                                        : id.toUpperCase());
      let color = pastel[i % pastel.length];
      if(isChr13){ color = (/s/.test(id) ? colBlack : colWhite); }
      out[id] = { left, top, w, h, rot, z:i+1, label, color, shape:'oval', sound:null,
        par:{gain:1,semi:0,atk:0.01,dec:0.9,pan:0} };
    });
    return out;
  }

  // siatka dla reszty
  const cols=3, rows=Math.ceil(list.length/cols);
  const cellW=(100-8)/cols, cellH=(100-8)/Math.max(rows,2);
  list.forEach((id,i)=>{ const c=i%cols, r=Math.floor(i/cols);
    out[id]={left:2+c*cellW, top:2+r*cellH, w:cellW-2, h:cellH-4, rot:0,
      label:id.toUpperCase(), color:null, z:i+1, shape: shapeClass(id), sound:null,
      par:{gain:1,semi:0,atk:0.01,dec:0.2,pan:0}};
  });
  return out;
}

/* toggles/theme/bpm */
function setToggle(btn,on){ btn.dataset.on = on?'1':'0'; }
function applyUseBtn(){ setToggle(layoutUseBtn, useCanvasLayout); }
function applyTheme(t){ document.body.classList.toggle('theme-neon', t==='neon'); setToggle(themeBtn, t==='neon'); }
let theme = localStorage.getItem('theme') || 'dark'; applyTheme(theme);
themeBtn.onclick = ()=>{ theme=(theme==='neon'?'dark':'neon'); localStorage.setItem('theme',theme); applyTheme(theme); };
function setBpmDisplay(v){ bpmVal.textContent=String(v); bpmTopVal.textContent=String(v); }
setBpmDisplay(bpmEl.value);
bpmEl.addEventListener('input',(e)=>{ setBpmDisplay(e.target.value); if(metroOn) restartMetro(); });

/* ====== EDIT PANEL refs ====== */
const editPanel=document.getElementById('editPanel');
const epLabel=document.getElementById('epLabel');
const inpLabel=document.getElementById('inpLabel');
const btnColor=document.getElementById('btnColor');
const inpColor=document.getElementById('inpColor');
const selShape=document.getElementById('selShape');
const btnEPOk=document.getElementById('btnEPOk');
const btnSoundFile=document.getElementById('btnSoundFile');
const inpSoundFile=document.getElementById('inpSoundFile');
const btnSoundUrl=document.getElementById('btnSoundUrl');
const btnClrSound=document.getElementById('btnClrSound');

const rGain=document.getElementById('rGain');
const rSemi=document.getElementById('rSemi');
const rAtk=document.getElementById('rAtk');
const rDec=document.getElementById('rDec');
const rPan=document.getElementById('rPan');
const lblGain=document.getElementById('lblGain');
const lblSemi=document.getElementById('lblSemi');
const lblAtk=document.getElementById('lblAtk');
const lblDec=document.getElementById('lblDec');
const lblPan=document.getElementById('lblPan');
const liveToggle=document.getElementById('liveToggle');
const btnTest=document.getElementById('btnTest');
const btnResetPar=document.getElementById('btnResetPar');

let livePreviewOn = true;
let previewTimer = null;
function fmtDbFromGain(g){ if(g<=0) return '-∞ dB'; const db=20*Math.log10(g); const v=(Math.round(db*10)/10).toFixed(1); return (db>0?`+${v}`:v)+' dB'; }
function updateValueLabels(){
  const g=parseFloat(rGain.value);
  lblGain.textContent=`${g.toFixed(2)} (${fmtDbFromGain(g)})`;
  lblSemi.textContent=`${parseInt(rSemi.value,10)}`;
  lblAtk.textContent =`${parseFloat(rAtk.value).toFixed(2)} s`;
  lblDec.textContent =`${parseFloat(rDec.value).toFixed(2)} s`;
  lblPan.textContent =`${parseFloat(rPan.value).toFixed(1)}`;
}
function defaultPar(){ return {gain:1,semi:0,atk:0.01,dec:0.2,pan:0}; }

/* sync panel podczas przesuwania */
function updateEditPanelFromEl(el){
  if(!el) return;
  if(editPanelVisible && selectedPadEl===el){
    epLabel.textContent = el.dataset.sound.toUpperCase();
  }
}

/* ====== RENDER ====== */
function renderPads(){
  const list=(KITS[currentKit]||[]).slice(0,13);
  const saved=getSavedPositions();
  const playCanvas=(!layoutMode && useCanvasLayout) || layoutMode;
  stage.className=playCanvas?'canvas':'grid';
  stage.innerHTML='';

  const baseDefault = defaultPositionsForKit(list);
  const P = layoutMode ? (draftPositions||{}) : (Object.keys(saved).length? saved : baseDefault);

  if(!playCanvas){
    list.forEach(id=>{
      const cfg = mergePadCfg(baseDefault[id], saved[id]);
      const el=document.createElement('div');
      el.className=`pad ${cfg.shape||shapeClass(id)} ${colorClass(id)}`;
      el.dataset.sound=id;
      el.textContent=cfg.label || id.toUpperCase();
      if(cfg.color) el.style.background = cfg.color;

      const down = (e)=>{ e.preventDefault?.(); startAudio(); padDown(el,cfg); };
      el.addEventListener('pointerdown', down, {passive:false});
      el.addEventListener('touchstart', down, {passive:false});
      el.addEventListener('pointerup', ()=>el.classList.remove('active'));
      el.addEventListener('pointercancel', ()=>el.classList.remove('active'));

      stage.appendChild(el);
    });
  }else{
    list.forEach((id)=>{
      const cfg = mergePadCfg(baseDefault[id], P[id]);
      const el=document.createElement('div');
      el.className=`pad ${cfg.shape||shapeClass(id)} ${colorClass(id)}`;
      el.dataset.sound=id;

      el.style.left=(cfg.left??10)+'%';
      el.style.top=(cfg.top??2)+'%';
      el.style.width=(cfg.w??80)+'%';
      el.style.height=(cfg.h??6)+'%';
      el.style.zIndex=String(cfg.z||1);
      if(cfg.color) el.style.background=cfg.color;
      el.style.transform = `rotate(${cfg.rot||0}deg)`;

      const labelEl = document.createElement('div');
      labelEl.className = 'labelInner';
      labelEl.style.pointerEvents='none';
      labelEl.style.fontSize='14px';
      labelEl.style.fontWeight='800';
      labelEl.style.color = (/(#fff|f7f8f9|f2f4f6)/i.test(String(cfg.color)) ? '#111' : '#fff');
      labelEl.textContent = (cfg.label)||id.toUpperCase();
      el.appendChild(labelEl);

      const gear=document.createElement('div'); gear.className='gear'; gear.textContent='⚙️';
      gear.addEventListener('click',(ev)=>{ ev.stopPropagation(); selectPad(el); showEditPanel(el); });
      el.appendChild(gear);

      if(layoutMode){
        if(!isCymbalKit(currentKit)){
          el.addEventListener('pointerdown',(e)=>selectPad(el,e));
          makeDraggable(el);
          addHandles(el);
          el.addEventListener('dblclick', ()=>{ selectPad(el); showEditPanel(el); });
        }
      }else{
        const down = (e)=>{ e.preventDefault?.(); startAudio(); padDown(el,cfg); };
        el.addEventListener('pointerdown', down, {passive:false});
        el.addEventListener('touchstart', down, {passive:false});
        el.addEventListener('pointerup', ()=>el.classList.remove('active'));
        el.addEventListener('pointercancel', ()=>el.classList.remove('active'));
      }
      stage.appendChild(el);
    });
  }

  layoutBar.style.display = (layoutMode && !isCymbalKit(currentKit)) ? 'flex' : 'none';
  editPanel.style.display = (layoutMode && editPanelVisible && !isCymbalKit(currentKit))?'block':'none';
  if(!layoutMode) clearSelectionAndHandles();
}

/* ====== PLAY ====== */
function padDown(el,cfg){
  startAudio();
  const id=el.dataset.sound;
  const par=cfg?.par || defaultPar();

  const sound = cfg?.sound || getSavedPositions()[id]?.sound || null;
  if(sound){
    (async ()=>{
      try{
        const resp=await fetch(sound.src,{mode:'cors'}); const arr=await resp.arrayBuffer();
        const buf=await ctx.decodeAudioData(arr.slice(0));
        const src=ctx.createBufferSource(); src.buffer=buf;
        src.playbackRate.value=Math.pow(2,(par.semi||0)/12);
        const g=ctx.createGain(); const t=now(), atk=Math.max(0.001,par.atk||0.01), dec=Math.max(0.01,par.dec||0.2);
        g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(Math.max(0.0002,(par.gain||1)), t+atk); g.gain.exponentialRampToValueAtTime(0.0001, t+atk+dec);
        const dest = ctx.createStereoPanner ? (p=>{ const sp=ctx.createStereoPanner(); sp.pan.value=par.pan||0; return sp; })() : null;
        if(dest){ src.connect(g).connect(dest).connect(master); } else { src.connect(g).connect(master); }
        src.start(t);
      }catch(e){ console.warn('Audio URL error',e); }
    })();
  }else{
    if(HAND[id])      S.handpanNote(HAND[id], now(), par);
    else if(XYL[id])  S.handpanNote(XYL[id],  now(), par);
    else              S[id]?.(now(), par);
  }

  el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),140);
}

/* ====== LAYOUT MODE (tylko nie-cymbałki) ====== */
function enterLayout(){
  if(isCymbalKit(currentKit)){ alert('Układ cymbałków jest stały. Edycja pozycji wyłączona.'); return; }
  layoutMode = true;
  const list = (KITS[currentKit]||[]).slice(0,13);
  const saved = getSavedPositions();
  draftPositions = Object.keys(saved).length ? structuredClone(saved)
                                             : defaultPositionsForKit(list);
  selectedPadEl = null;
  renderPads();
}
function exitLayout(save){
  if(save && draftPositions){
    const list = (KITS[currentKit]||[]).slice(0,13);
    const base = defaultPositionsForKit(list);
    const merged = {};
    list.forEach(id => merged[id] = mergePadCfg(base[id], draftPositions[id]));
    setSavedPositions(merged);
  }
  layoutMode=false; draftPositions=null; selectedPadEl=null;
  hideEditPanel(); clearSelectionAndHandles(); renderPads();
}
layoutSave.onclick = ()=> exitLayout(true);
layoutCancel.onclick = ()=> exitLayout(false);
layoutProps.onclick = ()=>{ if(selectedPadEl){ showEditPanel(selectedPadEl); } else { alert('Wybierz pad (stuknij), potem „Cechy…”'); } };

/* Drag/Scale/Rotate – nieużywane w cymbałkach */
function stageRect(){ return stage.getBoundingClientRect(); }
function getRotationFromTransform(tr){ const m=/rotate\(([-\d.]+)deg\)/.exec(tr||''); return m?parseFloat(m[1]):0; }
function clampPc(v){ return Math.min(98, Math.max(2, v)); }
function makeDraggable(el){
  let sx=0,sy=0,sl=0,st=0,drag=false;
  const down=(ev)=>{ if(!layoutMode) return;
    drag=true; el.classList.add('dragging');
    const R=stageRect(), P=el.getBoundingClientRect();
    sl=((P.left-R.left)/R.width)*100; st=((P.top-R.top)/R.height)*100;
    sx=ev.clientX||(ev.touches&&ev.touches[0].clientX); sy=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    addEventListener('pointermove',move); addEventListener('pointerup',up,{once:true});
    addEventListener('touchmove',move,{passive:false}); addEventListener('touchend',up,{once:true});
  };
  const move=(ev)=>{ if(!drag) return; ev.preventDefault?.();
    const x=ev.clientX||(ev.touches&&ev.touches[0].clientX), y=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    const R=stageRect(); const dx=((x-sx)/R.width)*100, dy=((y-sy)/R.height)*100;
    const newLeft = clampPc(sl+dx), newTop = clampPc(st+dy);
    el.style.left = newLeft + '%';
    el.style.top  = newTop + '%';
    updateEditPanelFromEl(el);
  };
  const up=()=>{ drag=false; el.classList.remove('dragging');
    removeEventListener('pointermove',move); removeEventListener('touchmove',move);
    savePadRect(el);
  };
  el.addEventListener('pointerdown',down); el.addEventListener('touchstart',down,{passive:true});
}
function addHandles(el){
  el.querySelectorAll('.handle').forEach(h=>h.remove());
  ['nw','ne','sw','se','rot'].forEach(pos=>{
    const h=document.createElement('div'); h.className='handle h-'+pos; el.appendChild(h);
    h.addEventListener('pointerdown',(e)=>startTransform(e, el, pos));
    h.addEventListener('touchstart',(e)=>startTransform(e, el, pos),{passive:true});
  });
}
function startTransform(e, el, type){
  if(!layoutMode) return; e.preventDefault?.();
  const R=stageRect(), P=el.getBoundingClientRect();
  const start={ l:((P.left-R.left)/R.width)*100, t:((P.top-R.top)/R.height)*100, w:(P.width/R.width)*100, h:(P.height/R.height)*100, rot:getRotationFromTransform(el.style.transform)||0 };
  const sx=e.clientX||(e.touches&&e.touches[0].clientX); const sy=e.clientY||(e.touches&&e.touches[0].clientY);
  const move=(ev)=>{
    const x=ev.clientX||(ev.touches&&ev.touches[0].clientX), y=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    const dx=((x-sx)/R.width)*100, dy=((y-sy)/R.height)*100;
    if(type==='rot'){
      const b=el.getBoundingClientRect(); const cx=(b.left-R.left)+b.width/2, cy=(b.top-R.top)+b.height/2;
      const ang=Math.atan2((y-(R.top+cy)),(x-(R.left+cx))); const deg=Math.round((ang*180/Math.PI+90));
      el.style.transform=`rotate(${deg}deg)`;
    }else{
      let l=start.l, t=start.t, w=start.w, h=start.h;
      if(type==='se'){ w=clampPc(start.w+dx); h=clampPc(start.h+dy); }
      if(type==='ne'){ w=clampPc(start.w+dx); h=clampPc(start.h-dy); t=clampPc(start.t+dy); }
      if(type==='sw'){ w=clampPc(start.w-dx); h=clampPc(start.h+dy); l=clampPc(start.l+dx); }
      if(type==='nw'){ w=clampPc(start.w-dx); h=clampPc(start.h-dy); l=clampPc(start.l+dx); t=clampPc(start.t+dy); }
      el.style.left=l+'%'; el.style.top=t+'%'; el.style.width=w+'%'; el.style.height=h+'%';
    }
  };
  const up=()=>{ removeEventListener('pointermove',move); removeEventListener('pointerup',up);
    removeEventListener('touchmove',move); removeEventListener('touchend',up); savePadRect(el); };
  addEventListener('pointermove',move); addEventListener('pointerup',up,{once:true});
  addEventListener('touchmove',move,{passive:false}); addEventListener('touchend',up,{once:true});
}
function savePadRect(el){
  if(!draftPositions) draftPositions={};
  const id=el.dataset.sound; const R=stageRect(), P=el.getBoundingClientRect();
  const prev = draftPositions[id]||{};
  const bg = el.style.background || prev.color || null;
  const shape = [...el.classList].find(c=>c.startsWith('shape-'))?.replace('shape-','') || prev.shape || 'round';
  draftPositions[id] = {
    left:((P.left-R.left)/R.width)*100,
    top:((P.top-R.top)/R.height)*100,
    w:(P.width/R.width)*100,
    h:(P.height/R.height)*100,
    rot:getRotationFromTransform(el.style.transform)||prev.rot||0,
    label: (el.querySelector('.labelInner')?.textContent || el.textContent).replace('⚙️','').trim(),
    color: bg,
    shape: shape,
    z: parseInt(el.style.zIndex||prev.z||'1',10),
    par: prev.par || defaultPar(),
    sound: prev.sound ?? null
  };
}

/* EDIT PANEL show/hide */
const editPanelEl=document.getElementById('editPanel');
function showEditPanel(anchorEl){
  if(isCymbalKit(currentKit)) return;
  editPanelVisible=true; editPanelEl.style.display='block';
  if(anchorEl){
    const R=stage.getBoundingClientRect(); const P=anchorEl.getBoundingClientRect();
    const padBottomPct=((P.bottom-R.top)/R.height)*100;
    if(padBottomPct>65){ editPanelEl.classList.add('at-top'); } else { editPanelEl.classList.remove('at-top'); }
  }
  const id=currentCfgId(); if(!id) return;
  const cfg=(draftPositions&&draftPositions[id]) || getSavedPositions()[id] || {};
  epLabel.textContent = id.toUpperCase();
  inpLabel.value=(cfg.label)||id.toUpperCase();
  selShape.value=(cfg.shape)||'round';
  if(cfg.color && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(cfg.color)) inpColor.value=cfg.color;
  const p=cfg.par||defaultPar();
  rGain.value=p.gain; rSemi.value=p.semi; rAtk.value=p.atk; rDec.value=p.dec; rPan.value=p.pan;
  updateValueLabels();
}
function hideEditPanel(){ editPanelVisible=false; editPanelEl.style.display='none'; }
function selectPad(el,e){ e?.preventDefault?.(); selectedPadEl=el;
  document.querySelectorAll('.pad').forEach(p=>p.classList.toggle('selected', p===el)); }
function clearSelectionAndHandles(){ document.querySelectorAll('.pad.selected').forEach(p=>p.classList.remove('selected'));
  document.querySelectorAll('.pad .handle').forEach(h=>h.remove()); hideEditPanel(); selectedPadEl=null; }
btnEPOk.addEventListener('click', ()=> hideEditPanel());
function currentCfgId(){ return selectedPadEl?.dataset.sound; }

/* label/kolor/kształt */
inpLabel.addEventListener('input', ()=>{
  if(!selectedPadEl) return;
  const gear=selectedPadEl.querySelector('.gear');
  const label = (inpLabel.value.trim()||selectedPadEl.dataset.sound.toUpperCase());
  const labelEl = selectedPadEl.querySelector('.labelInner') || selectedPadEl;
  if(labelEl.classList && labelEl.classList.contains('labelInner')) labelEl.textContent = label;
  else selectedPadEl.textContent = label;
  if(gear) selectedPadEl.appendChild(gear);
  savePadRect(selectedPadEl);
});
btnColor.addEventListener('click', ()=> inpColor.click());
inpColor.addEventListener('input', ()=>{ if(!selectedPadEl) return; selectedPadEl.style.background=inpColor.value; savePadRect(selectedPadEl); });
selShape.addEventListener('change', ()=>{ if(!selectedPadEl) return; ['shape-round','shape-oval','shape-circle'].forEach(c=>selectedPadEl.classList.remove(c)); selectedPadEl.classList.add('shape-'+selShape.value); savePadRect(selectedPadEl); });

/* Parametry + LIVE odsłuch */
function clampNum(v,min,max,def){ v=isFinite(v)?v:def; return Math.min(max,Math.max(min,v)); }
function writeParToDraft(){
  const id=currentCfgId(); if(!id) return;
  draftPositions = draftPositions||{}; draftPositions[id]=draftPositions[id]||{};
  draftPositions[id].par = {
    gain: clampNum(parseFloat(rGain.value),0,2,1),
    semi: clampNum(parseInt(rSemi.value||0),-24,24,0),
    atk:  clampNum(parseFloat(rAtk.value),0,1.5,0.01),
    dec:  clampNum(parseFloat(rDec.value),0.05,3,0.2),
    pan:  clampNum(parseFloat(rPan.value),-1,1,0)
  };
}
function triggerPreviewDebounced(){
  if(!livePreviewOn) return;
  clearTimeout(previewTimer);
  previewTimer = setTimeout(()=>{
    const el=selectedPadEl; if(!el) return;
    const id=el.dataset.sound;
    const saved=getSavedPositions()[id]||{};
    const livePar = (draftPositions?.[id]?.par) || defaultPar();
    const cfg={ ...mergePadCfg(defaultPositionsForKit([id])[id], saved), par: {...livePar} };
    startAudio();
    padDown(el, cfg);
  }, 140);
}
[rGain,rSemi,rAtk,rDec,rPan].forEach(inp=>{
  inp.addEventListener('input', ()=>{
    updateValueLabels();
    writeParToDraft();
    triggerPreviewDebounced();
  });
});
liveToggle.addEventListener('click', ()=>{
  livePreviewOn = !(liveToggle.dataset.on==='1');
  liveToggle.dataset.on = livePreviewOn ? '1':'0';
});
btnTest.addEventListener('click', ()=>{
  const el=selectedPadEl; if(!el) return;
  const id=el.dataset.sound;
  const saved=getSavedPositions()[id]||{};
  const livePar = (draftPositions?.[id]?.par) || defaultPar();
  const cfg={ ...mergePadCfg(defaultPositionsForKit([id])[id], saved), par: {...livePar} };
  startAudio();
  padDown(el, cfg);
});
btnResetPar.addEventListener('click', ()=>{
  const id=currentCfgId(); if(!id) return;
  const d=defaultPar();
  rGain.value=d.gain; rSemi.value=d.semi; rAtk.value=d.atk; rDec.value=d.dec; rPan.value=d.pan;
  updateValueLabels(); writeParToDraft(); triggerPreviewDebounced();
});

/* ====== MENU ====== */
function fillKits(){ kitSelect.innerHTML=''; Object.keys(KITS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; if(k===currentKit) o.selected=true; kitSelect.appendChild(o); }); }
function openMenu(){
  startAudio(); fillKits(); applyUseBtn(); menuPanel.style.display='block';
  const cym = isCymbalKit(kitSelect.value);
  layoutStart.disabled = cym;
  layoutStart.textContent = cym ? 'Układ stały' : 'START';
}
function closeMenu(){ menuPanel.style.display='none'; }
menuBtn.onclick=openMenu;
menuCancel.onclick=()=>{ closeMenu(); clearSelectionAndHandles(); renderPads(); };
menuOk.onclick=()=>{
  const chosen=kitSelect.value; if(chosen && chosen!==currentKit){ currentKit=chosen; localStorage.setItem('kitName',currentKit); }
  if(layoutMode) exitLayout(true); else { clearSelectionAndHandles(); renderPads(); }
  closeMenu();
};
layoutStart.onclick=()=>{ if(isCymbalKit(currentKit)){ alert('Układ cymbałków jest stały.'); closeMenu(); return; } closeMenu(); enterLayout(); };
layoutUseBtn.addEventListener('click', ()=>{
  useCanvasLayout=!useCanvasLayout; localStorage.setItem(layoutUseKey, useCanvasLayout?'1':'0'); applyUseBtn();
  if(layoutMode) exitLayout(true); else { clearSelectionAndHandles(); renderPads(); }
});

/* Size & Volume */
sizeEl.addEventListener('input',(e)=>{
  const v=Number(e.target.value); const scale=v/100;
  document.documentElement.style.setProperty('--size-min',  Math.round(84*scale)+'px');
  document.documentElement.style.setProperty('--size-vw',   (28*scale)+'vw');
  document.documentElement.style.setProperty('--size-max',  Math.round(160*scale)+'px');
});
vol.addEventListener('input',()=>{ if(!volumeNode) return; volumeNode.gain.value=parseFloat(vol.value); });

/* ====== METRONOM ====== */
let metroOn=false, metroTimer=null;
const metroBtn=document.getElementById('metroBtn');
metroBtn.addEventListener('click', ()=>{
  const on=metroBtn.dataset.on==='1';
  setToggle(metroBtn, !on);
  metroOn=!on;
  startAudio();
  if(metroOn){ startMetro(); } else { stopMetro(); }
});
function startMetro(){ if(!ctx) initAudio(); scheduleMetro(); }
function stopMetro(){ if(metroTimer){ clearInterval(metroTimer); metroTimer=null; } }
function restartMetro(){ if(metroOn){ stopMetro(); startMetro(); } }
function scheduleMetro(){
  const bpm=parseInt(bpmEl.value||'100',10);
  const periodMs=(60/bpm)*1000;
  metroTick(); metroTimer=setInterval(metroTick, periodMs);
}
function metroTick(){
  if(!ctx) return;
  const t=now();
  const o=ctx.createOscillator(); o.type='square'; o.frequency.setValueAtTime(2000,t);
  const g=ctx.createGain(); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.7,t+0.005); g.gain.exponentialRampToValueAtTime(0.0001,t+0.05);
  o.connect(g).connect(master); o.start(t); o.stop(t+0.08);
}

/* INIT */
function initialRender(){ applyUseBtn(); renderPads(); }
window.addEventListener('load', initialRender);
function firstGesture(){ startAudio(); window.removeEventListener('pointerdown', firstGesture); window.removeEventListener('keydown', firstGesture); }
window.addEventListener('pointerdown', firstGesture, {once:true});
window.addEventListener('keydown', firstGesture, {once:true});

/* SW (opcjonalnie) */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
</script>
</body>
</html>
