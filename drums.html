<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Drum Pad v3.1 ‚Äî PWA + Jam</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-512.png">
<meta name="theme-color" content="#0b0d10">
<style>
:root{
  --bg:#0b0d10; --text:#e6edf3; --muted:#9aa4ad;
  --pad:#1b1f24; --pad2:#14181d; --pad-active:#2d333b;
  --accent:#4aa3ff;
  --topbar-h: 56px;
  --footer-h: 42px;
}

/* Reset */
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-tap-highlight-color:transparent; touch-action:manipulation}

/* Topbar: mo≈ºe siƒô zawijaƒá */
.topbar{
  position:fixed; top:0; left:0; right:0; z-index:60;
  display:flex; flex-wrap:wrap; gap:.5rem; align-items:center;
  padding:.6rem env(safe-area-inset-right,12px) .6rem env(safe-area-inset-left,12px);
  background:linear-gradient(180deg,rgba(0,0,0,.5),rgba(0,0,0,0));
}
.title{font-weight:800; letter-spacing:.4px; margin-right:auto; display:flex; gap:.4rem; align-items:center}
.btn{
  appearance:none; cursor:pointer; font-weight:700; color:var(--text);
  background:var(--pad); border:1px solid #2b3138; border-radius:.6rem; padding:.5rem .75rem;
}
.btn:active{transform:scale(.98)}
.range{display:flex; align-items:center; gap:.45rem; font-size:.9rem}
.range input{ width:110px }

/* SCENA ‚Äì zawsze zostawia miejsce na topbar i stopkƒô */
#stage{
  position:fixed;
  top: calc(var(--topbar-h) + 8px);
  left: 0; right: 0;
  bottom: calc(env(safe-area-inset-bottom,0px) + var(--footer-h) + 6px);
  padding: .8rem;
  overflow:hidden;
}

/* GRID ‚Äì adaptacyjne kolumny */
.grid{
  display:grid;
  gap:.8rem;
  grid-template-columns: repeat(auto-fit, minmax(clamp(84px, 28vw, 160px), 1fr));
  grid-auto-rows: minmax(clamp(72px, 16vh, 180px), 1fr);
  align-content:start;
}

/* CANVAS (uk≈Çad) ‚Äì pady absolutnie pozycjonowane */
.canvas{ position:relative; }
.canvas .pad{ position:absolute; touch-action:none; }

/* Pady: kszta≈Çty + kolory */
.pad{
  background:var(--pad); border:1px solid #2b3138; border-radius:1rem;
  display:flex; align-items:center; justify-content:center; text-align:center;
  padding:.45rem; user-select:none; -webkit-user-select:none; font-weight:800; letter-spacing:.3px;
  box-shadow:0 2px 0 rgba(0,0,0,.5) inset, 0 6px 18px rgba(0,0,0,.25);
}
.pad.active{
  background:var(--pad-active); outline:2px solid var(--accent);
  box-shadow:0 0 0 4px rgba(74,163,255,.15), 0 10px 28px rgba(0,0,0,.4) inset;
  transform:scale(.99)
}
.pad.dragging{ opacity:.95; outline:2px dashed var(--accent) }

/* Kszta≈Çty */
.shape-circle{ border-radius:999px }
.shape-rect{ border-radius:1rem }
.shape-hex{ clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%) }
.shape-tri{ clip-path:polygon(50% 0%,0% 100%,100% 100%) }
.shape-drum{ clip-path:path("M10,50 C10,20 90,20 90,50 C90,80 10,80 10,50 Z"); border-radius:0 }

/* Kolorystyka kategorii (delikatne, czytelne) */
.c-kick   { background: radial-gradient(120% 120% at 30% 30%, #2a3a20, #1c2416 70%); }
.c-snare  { background: radial-gradient(120% 120% at 30% 30%, #2b2e3a, #171a21 70%); }
.c-hats   { background: radial-gradient(120% 120% at 30% 30%, #27333d, #151c22 70%); }
.c-toms   { background: radial-gradient(120% 120% at 30% 30%, #2d3131, #171a1a 70%); }
.c-cym    { background: radial-gradient(120% 120% at 30% 30%, #303227, #181a12 70%); }
.c-latin  { background: radial-gradient(120% 120% at 30% 30%, #2e2a33, #18161c 70%); }
.c-hand   { background: radial-gradient(120% 120% at 30% 30%, #2a2e38, #151922 70%); }
.c-flute  { background: radial-gradient(120% 120% at 30% 30%, #273235, #131a1c 70%); }
.c-fun    { background: radial-gradient(120% 120% at 30% 30%, #3a2a2a, #211515 70%); }

/* Panele */
.panel{
  position:fixed; right:.8rem; top:calc(var(--topbar-h) + .8rem); z-index:70;
  width:min(600px,92vw); max-height:70vh; overflow:auto;
  background:#0e1116; border:1px solid #2b3138; border-radius:1rem; padding:.8rem; display:none;
}
.panel h3{ margin:.2rem 0 .6rem 0 }
.list{ display:grid; grid-template-columns:repeat(2,1fr); gap:.35rem .75rem }
.list button{
  padding:.45rem .6rem; text-align:left; border-radius:.5rem; background:var(--pad2); color:var(--text); border:1px solid #2b3138; cursor:pointer;
}
.list button:hover{ background:#161b22 }
.badge{ font-size:.75rem; color:var(--muted) }

/* Jam status */
#jamInfo{
  position:fixed; left:.8rem; top:calc(var(--topbar-h) + .8rem); z-index:65;
  background:#0e1116; border:1px solid #2b3138; border-radius:.75rem; padding:.35rem .6rem; font-size:.85rem; display:none
}
#jamInfo .room{ color:#7bdcff }

/* Overlay iOS (tap to start) */
#tapStart{
  position:fixed; inset:0; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1rem;
  padding:2rem; text-align:center; color:var(--text); background:rgba(0,0,0,.86)
}
#tapStart .big{ font-size:1.25rem; font-weight:800 }
#tapStart .hint{ opacity:.8 }

/* Stopka ‚Äì nie blokuje klik√≥w + rezerwujemy na niƒÖ miejsce */
.footer{
  position:fixed; left:0; right:0; bottom:0; z-index:10;
  height: var(--footer-h);
  padding:.4rem env(safe-area-inset-right,12px) calc(env(safe-area-inset-bottom,12px) + .2rem) env(safe-area-inset-left,12px);
  display:flex; justify-content:center; align-items:center; gap:.6rem;
  font-size:.8rem; opacity:.7; text-align:center;
  pointer-events: none;  /* <<< klucz: nie przechwytuje stukniƒôƒá */
}
/* Bardzo ma≈Çe ekrany ‚Äî ukryj stopkƒô by daƒá wiƒôcej miejsca */
@media (max-height: 680px){
  .footer{ display:none }
  #stage{ bottom: calc(env(safe-area-inset-bottom,0px) + 6px) }
}
</style>
</head>
<body>

<div class="topbar">
  <div class="title">ü•Å Drum Pad v3.1</div>
  <button id="kitsBtn" class="btn" aria-expanded="false">Zestaw</button>
  <button id="layoutBtn" class="btn">Uk≈Çad</button>
  <button id="jamBtn" class="btn">Jam: OFF</button>
  <button id="startBtn" class="btn">Start audio</button>
  <div class="range">G≈Ço≈õno≈õƒá <input id="volume" type="range" min="0" max="1" step="0.01" value="0.9"></div>
</div>

<div id="jamInfo">Jam ON ‚Äî pok√≥j: <span class="room" id="jamRoomLabel">‚Äî</span></div>

<div id="tapStart">
  <div class="big">Dotknij, aby rozpoczƒÖƒá</div>
  <button id="tapStartBtn" class="btn">Start audio</button>
  <div class="hint">iOS/Safari wymaga dotkniƒôcia ekranu, by w≈ÇƒÖczyƒá d≈∫wiƒôk</div>
</div>

<!-- Scena -->
<div id="stage" class="grid"></div>

<div class="footer">
  <span>Multi-touch. Na komputerze: QWER / ASDF / ZXCV.</span>
  <span>Na iPhonie dodaj do ekranu poczƒÖtkowego (PWA).</span>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* WSTAW SW√ìJ firebaseConfig (z konsoli Firebase) */
const firebaseConfig = {
  apiKey: "PLACEHOLDER",
  authDomain: "PLACEHOLDER.firebaseapp.com",
  databaseURL: "https://PLACEHOLDER-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "PLACEHOLDER",
  storageBucket: "PLACEHOLDER.appspot.com",
  messagingSenderId: "PLACEHOLDER",
  appId: "PLACEHOLDER"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
/* ===== AUDIO CORE ===== */
let ctx=null, master=null, volumeNode=null, started=false;
const vol = document.getElementById('volume');
function initAudio(){
  if (ctx) return;
  const AC = window.AudioContext || window.webkitAudioContext;
  ctx = new AC({latencyHint:'interactive'});
  master = ctx.createGain(); volumeNode = ctx.createGain();
  master.connect(volumeNode).connect(ctx.destination);
  volumeNode.gain.value = parseFloat(vol.value);
  const o = ctx.createOscillator(), g = ctx.createGain();
  g.gain.value = 0.0001; o.connect(g).connect(master); o.start(); o.stop(ctx.currentTime+0.02);
}
async function startAudio(){ initAudio(); if (ctx.state==='suspended') await ctx.resume();
  started = true; document.getElementById('tapStart').style.display='none';
  startBtn.textContent='Gotowe'; startBtn.disabled=true; }
function envGain(time,g,a=0.001,d=0.2,sustain=0.0,r=0.2){
  g.gain.cancelScheduledValues(time); g.gain.setValueAtTime(0.0001,time);
  g.gain.exponentialRampToValueAtTime(1.0,time+a);
  g.gain.exponentialRampToValueAtTime(Math.max(0.0001,sustain),time+a+d);
  g.gain.exponentialRampToValueAtTime(0.0001,time+a+d+r);
}
function noiseBuffer(){
  const len=Math.floor(ctx.sampleRate*2.0), buffer=ctx.createBuffer(1,len,ctx.sampleRate), data=buffer.getChannelData(0);
  for(let i=0;i<len;i++) data[i]=Math.random()*2-1; return buffer;
}
const sharedNoise=(()=>{let _b=null;return()=>_b||(_b=noiseBuffer())})();

/* ===== SYNTEZA (jak v3) ‚Äì skr√≥t ===== */
function now(){ return ctx ? ctx.currentTime : 0; }
const S = {
  kick(t=now()){ const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(50,t+.5);
    g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(.0001,t+.5); o.connect(g).connect(master); o.start(t); o.stop(t+.6); },
  kick808(t=now()){ const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(70,t); o.frequency.exponentialRampToValueAtTime(38,t+.6);
    g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(.0001,t+.75);
    const click=ctx.createBufferSource(); click.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200;
    const gc=ctx.createGain(); gc.gain.value=.5; gc.gain.exponentialRampToValueAtTime(.0001,t+.03);
    click.connect(hp).connect(gc).connect(master); click.start(t); click.stop(t+.05);
    o.connect(g).connect(master); o.start(t); o.stop(t+.8); },
  snare(t=now()){ const o=ctx.createOscillator(); o.type='sine'; o.frequency.value=180;
    const gTone=ctx.createGain(); gTone.gain.value=.5; gTone.gain.exponentialRampToValueAtTime(.0001,t+.18);
    o.connect(gTone).connect(master); o.start(t); o.stop(t+.2);
    const nb=ctx.createBufferSource(); nb.buffer=sharedNoise();
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=.5;
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=700;
    const g=ctx.createGain(); envGain(t,g,.001,.06,.01,.12); nb.connect(bp).connect(hp).connect(g).connect(master);
    nb.start(t); nb.stop(t+.25); },
  hatClosed(t=now()){ const nb=ctx.createBufferSource(); nb.buffer=sharedNoise();
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000;
    const g=ctx.createGain(); envGain(t,g,.001,.02,.001,.05); nb.connect(hp).connect(g).connect(master);
    nb.start(t); nb.stop(t+.1); },
  hatOpen(t=now()){ const nb=ctx.createBufferSource(); nb.buffer=sharedNoise();
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000;
    const g=ctx.createGain(); envGain(t,g,.001,.08,.05,.5); nb.connect(hp).connect(g).connect(master);
    nb.start(t); nb.stop(t+.8); },
  tomHigh(t=now()){ const o=ctx.createOscillator(); o.type='sine';
    o.frequency.setValueAtTime(330,t); o.frequency.exponentialRampToValueAtTime(180,t+.32);
    const g=ctx.createGain(); envGain(t,g,.001,.12,.01,.22); o.connect(g).connect(master); o.start(t); o.stop(t+.38); },
  tomLow(t=now()){ const o=ctx.createOscillator(); o.type='sine';
    o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(120,t+.35);
    const g=ctx.createGain(); envGain(t,g,.001,.15,.01,.25); o.connect(g).connect(master); o.start(t); o.stop(t+.4); },
  clap(t=now()){ const nb=ctx.createBufferSource(); nb.buffer=sharedNoise();
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1000; bp.Q.value=.6;
    const g=ctx.createGain(); g.gain.value=.0001;
    g.gain.setValueAtTime(.9,t); g.gain.exponentialRampToValueAtTime(.0001,t+.02);
    g.gain.setValueAtTime(.8,t+.03); g.gain.exponentialRampToValueAtTime(.0001,t+.05);
    g.gain.setValueAtTime(.7,t+.06); g.gain.exponentialRampToValueAtTime(.0001,t+.12);
    nb.connect(bp).connect(g).connect(master); nb.start(t); nb.stop(t+.2); },
  crash(t=now()){ const nb=ctx.createBufferSource(); nb.buffer=sharedNoise();
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=4000;
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=10000; bp.Q.value=.5;
    const g=ctx.createGain(); envGain(t,g,.001,.12,.2,1.2); nb.connect(hp).connect(bp).connect(g).connect(master);
    nb.start(t); nb.stop(t+1.5); },
  ride(t=now()){ const nb=ctx.createBufferSource(); nb.buffer=sharedNoise();
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000;
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=8000; bp.Q.value=.7;
    const g=ctx.createGain(); envGain(t,g,.001,.2,.25,1.6); nb.connect(hp).connect(bp).connect(g).connect(master);
    nb.start(t); nb.stop(t+1.8);
    const o=ctx.createOscillator(); o.type='sine'; o.frequency.value=600;
    const g2=ctx.createGain(); g2.gain.value=.3; g2.gain.exponentialRampToValueAtTime(.0001,t+.12);
    o.connect(g2).connect(master); o.start(t); o.stop(t+.15); },
  rim(t=now()){ const o=ctx.createOscillator(); o.type='square'; o.frequency.value=2200;
    const g=ctx.createGain(); envGain(t,g,.001,.03,.001,.05); o.connect(g).connect(master); o.start(t); o.stop(t+.09); },
  perc(t=now()){ const nb=ctx.createBufferSource(); nb.buffer=sharedNoise();
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1200; bp.Q.value=3;
    const g=ctx.createGain(); envGain(t,g,.001,.08,.01,.25); nb.connect(bp).connect(g).connect(master);
    nb.start(t); nb.stop(t+.35); },
  /* + Afryka / Australia / Handpan / PanFlute / Fun ‚Äì jak w v3, pominƒÖ≈Çem tu dla skr√≥tu.
     ZACHOWAJ swoje S.* z poprzedniego pliku i wklej w to miejsce, je≈õli podmieniasz ca≈Ço≈õƒá. */
};

/* ===== Kszta≈Çty i kategorie kolor√≥w ===== */
const SHAPE = {
  circle: new Set(['crash','ride','hatClosed','hatOpen','pan1','pan2','pan3','pan4','pan5','pan6','pan7','pan8','pan9','flute1','flute2','flute3','flute4','flute5']),
  hex:    new Set(['tomHigh','tomLow','hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9']),
  tri:    new Set(['perc','rim','clapsticks']),
  drum:   new Set(['kick','kick808','djembeBass','djembeSlap','dundun','didgeridoo','fartShort','fartLong']),
  rect:   new Set(['snare','clap','woodblock','clave','shaker'])
};
const COLOR = {
  kick:  new Set(['kick','kick808','djembeBass','dundun']),
  snare: new Set(['snare','clap','clapsticks','woodblock','clave']),
  hats:  new Set(['hatClosed','hatOpen','shaker']),
  toms:  new Set(['tomHigh','tomLow']),
  cym:   new Set(['crash','ride']),
  hand:  new Set(['hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9']),
  flute: new Set(['flute1','flute2','flute3','flute4','flute5']),
  fun:   new Set(['fartShort','fartLong','perc','rim']),
};
function shapeClass(id){
  if (SHAPE.circle.has(id)) return 'shape-circle';
  if (SHAPE.hex.has(id)) return 'shape-hex';
  if (SHAPE.tri.has(id)) return 'shape-tri';
  if (SHAPE.drum.has(id)) return 'shape-drum';
  return 'shape-rect';
}
function colorClass(id){
  if (COLOR.kick.has(id))  return 'c-kick';
  if (COLOR.snare.has(id)) return 'c-snare';
  if (COLOR.hats.has(id))  return 'c-hats';
  if (COLOR.toms.has(id))  return 'c-toms';
  if (COLOR.cym.has(id))   return 'c-cym';
  if (COLOR.hand.has(id))  return 'c-hand';
  if (COLOR.flute.has(id)) return 'c-flute';
  if (COLOR.fun.has(id))   return 'c-fun';
  return '';
}

/* ===== Zestawy (jak w v3) ===== */
const KITS = {
  "Standard": ['kick808','snare','hatClosed','hatOpen','tomLow','tomHigh','clap','crash','ride','rim','perc','kick'],
  "Afryka":   ['djembeBass','djembeSlap','dundun','woodblock','clave','shaker','tomLow','tomHigh','crash','ride','rim','perc'],
  "Australia":['didgeridoo','clapsticks','tomLow','tomHigh','rim','perc','crash','ride','snare','clap','kick','kick808'],
  "Handpan":  ['hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9'],
  "PanFlute": ['flute1','flute2','flute3','flute4','flute5','flute3','flute2','flute4','flute5','flute1','rim','shaker'],
  "Fun":      ['fartShort','fartLong','clap','rim','perc','woodblock','clave','shaker','tomLow','tomHigh','crash','ride'],
};
const HAND = { hand1:146.83, hand2:220.00, hand3:261.63, hand4:293.66, hand5:329.63, hand6:349.23, hand7:392.00, hand8:440.00, hand9:523.25 };
const FL   = { flute1:261.63, flute2:293.66, flute3:329.63, flute4:392.00, flute5:523.25 };
function trigger(id){ if(!ctx) initAudio(); if(!started) return;
  if (id in HAND) return S.handpanNote(HAND[id]);
  if (id in FL)   return S.panFlute(FL[id]);
  return S[id]?.();
}

/* ===== Stage / Layout ===== */
const stage = document.getElementById('stage');
let currentKit = localStorage.getItem('kitName') || 'Standard';
let layoutMode = false;
const positionsKey = ()=>'padPositions:'+currentKit;

function renderPads(){
  stage.className = layoutMode ? 'canvas' : 'grid';
  stage.innerHTML = '';
  const pads=(KITS[currentKit]||[]).slice(0,12);
  pads.forEach((id,idx)=>{
    const el=document.createElement('div');
    el.className = `pad ${shapeClass(id)} ${colorClass(id)}`;
    el.dataset.sound=id; el.textContent=id.toUpperCase();
    if(layoutMode){
      el.style.width='30vw'; el.style.height='18vh';
      const P=JSON.parse(localStorage.getItem(positionsKey())||'{}');
      const pos=P[id]||{left:(idx%3)*32+2, top:Math.floor(idx/3)*20+2};
      el.style.left=pos.left+'%'; el.style.top=pos.top+'%';
      makeDraggable(el);
    }
    stage.appendChild(el);
  });
}
function makeDraggable(el){
  let sx=0,sy=0,sl=0,st=0,drag=false;
  const down=(ev)=>{
    drag=true; el.classList.add('dragging');
    const R=stage.getBoundingClientRect(), P=el.getBoundingClientRect();
    sl=((P.left-R.left)/R.width)*100; st=((P.top-R.top)/R.height)*100;
    sx=ev.clientX||(ev.touches&&ev.touches[0].clientX); sy=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    addEventListener('pointermove',move); addEventListener('pointerup',up);
    addEventListener('touchmove',move,{passive:false}); addEventListener('touchend',up);
  };
  const move=(ev)=>{
    if(!drag) return; ev.preventDefault?.();
    const x=ev.clientX||(ev.touches&&ev.touches[0].clientX), y=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    const R=stage.getBoundingClientRect(); const dx=((x-sx)/R.width)*100, dy=((y-sy)/R.height)*100;
    const L=Math.min(95,Math.max(0,sl+dx)), T=Math.min(95,Math.max(0,st+dy));
    el.style.left=L+'%'; el.style.top=T+'%';
  };
  const up=()=>{
    drag=false; el.classList.remove('dragging');
    removeEventListener('pointermove',move); removeEventListener('pointerup',up);
    removeEventListener('touchmove',move); removeEventListener('touchend',up);
    const P=JSON.parse(localStorage.getItem(positionsKey())||'{}');
    P[el.dataset.sound]={left:parseFloat(el.style.left), top:parseFloat(el.style.top)};
    localStorage.setItem(positionsKey(), JSON.stringify(P));
  };
  el.addEventListener('pointerdown',down);
  el.addEventListener('touchstart',down,{passive:true});
}

/* ===== UI ===== */
const kitsBtn=document.getElementById('kitsBtn');
const layoutBtn=document.getElementById('layoutBtn');
const jamBtn=document.getElementById('jamBtn');
const startBtn=document.getElementById('startBtn');
const tapStartBtn=document.getElementById('tapStartBtn');

const kitsPanel=document.createElement('div'); kitsPanel.className='panel'; kitsPanel.id='kitsPanel';
kitsPanel.innerHTML=`<h3>Wybierz zestaw</h3><div class="badge">Osobny uk≈Çad zapisywany dla ka≈ºdego zestawu.</div><div class="list" id="kitsList"></div>`;
document.body.appendChild(kitsPanel);
const kitsList=document.getElementById('kitsList');

function openKits(){
  kitsList.innerHTML='';
  Object.keys(KITS).forEach(name=>{
    const b=document.createElement('button'); b.textContent=name;
    b.onclick=()=>{ currentKit=name; localStorage.setItem('kitName',name); renderPads(); };
    kitsList.appendChild(b);
  });
  kitsPanel.style.display='block'; kitsBtn.setAttribute('aria-expanded','true');
}
function closeKits(){ kitsPanel.style.display='none'; kitsBtn.setAttribute('aria-expanded','false'); }
kitsBtn.addEventListener('click',()=> kitsPanel.style.display==='block' ? closeKits() : openKits());

layoutBtn.addEventListener('click',()=>{ layoutMode=!layoutMode; layoutBtn.textContent=layoutMode?'Uk≈Çad: ON':'Uk≈Çad'; renderPads(); });
['click','touchstart'].forEach(ev=>{
  startBtn.addEventListener(ev,()=>startAudio(),{passive:true});
  tapStartBtn.addEventListener(ev,()=>startAudio(),{passive:true});
});
vol.addEventListener('input',()=>{ if(volumeNode) volumeNode.gain.value=parseFloat(vol.value); });

/* ===== Keyboard (desktop) ===== */
const keyMap=['q','w','e','r','a','s','d','f','z','x','c','v'];
document.addEventListener('keydown',(e)=>{
  if(!started || layoutMode) return;
  const idx=keyMap.indexOf(e.key.toLowerCase()); const pads=(KITS[currentKit]||[]);
  if(idx>=0 && idx<pads.length){ const id=pads[idx]; trigger(id); jamEmit(id);
    const node=[...stage.querySelectorAll('.pad')][idx]; if(node) { node.classList.add('active'); setTimeout(()=>node.classList.remove('active'),120); } }
});

/* ===== JAM (jak w v3) ‚Äì minimal */ 
const jamInfo=document.createElement('div'); // label ju≈º mamy w CSS, ale upro≈õƒámy‚Ä¶
document.getElementById('jamInfo').style.display='none';
let jamOn=false, roomId=null, clientId=(crypto.getRandomValues(new Uint32Array(1))[0]).toString(16);
let roomRef=null, eventsRef=null, eventsListener=null;
function setJamUI(){ jamBtn.textContent='Jam: '+(jamOn?'ON':'OFF'); document.getElementById('jamInfo').style.display=jamOn?'block':'none';
  document.getElementById('jamRoomLabel').textContent=roomId||'‚Äî';}
function promptRoom(){ const code=prompt('Kod pokoju (np. ABC123):',(roomId||'JAM001')); return code?.replace(/[^A-Za-z0-9_-]/g,'').slice(0,24)||null; }
function jamEmit(padId){ if(!jamOn||!roomId) return; eventsRef.push({pad:padId,kit:currentKit,clientId,ts:Date.now()}).catch(()=>{}); }
async function jamEnable(){
  const code=promptRoom(); if(!code) return; roomId=code;
  const room = firebase.database().ref('rooms/'+roomId);
  roomRef=room; eventsRef=room.child('events');
  const pRef=room.child('presence').child(clientId); pRef.set({ts:firebase.database.ServerValue.TIMESTAMP}); pRef.onDisconnect().remove();
  if(eventsListener) eventsRef.off('child_added',eventsListener);
  eventsListener=eventsRef.limitToLast(64).on('child_added',(snap)=>{
    const ev=snap.val(); if(!ev||ev.clientId===clientId) return;
    if(Date.now()-(ev.ts||0)>5000){ snap.ref.remove(); return; }
    if(ev.kit && ev.kit!==currentKit) return;
    trigger(ev.pad);
    const pad=[...stage.querySelectorAll('.pad')].find(p=>p.dataset.sound===ev.pad); if(pad){ pad.classList.add('active'); setTimeout(()=>pad.classList.remove('active'),120); }
  });
  jamOn=true; setJamUI();
}
function jamDisable(){ jamOn=false; setJamUI(); if(eventsListener&&eventsRef) eventsRef.off('child_added',eventsListener);
  eventsListener=null; if(roomRef){ roomRef.child('presence').child(clientId).remove(); } }
jamBtn.addEventListener('click',()=>{ if(!jamOn) jamEnable(); else jamDisable(); });

/* ===== Start ===== */
renderPads();
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible' && (!ctx||ctx.state!=='running')) document.getElementById('tapStart').style.display='flex'; });
document.getElementById('tapStart').style.display='flex';
</script>

<script>
/* Service Worker (je≈õli u≈ºywasz PWA) */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}
</script>
</body>
</html>

