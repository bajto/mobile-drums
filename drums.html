<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum=1, user-scalable=no, viewport-fit=cover">
<title>Mobile-Drums – Edytor i Pad Live</title>
<style>
  :root{
    --bg:#0f1115;
    --panel:#181c22;
    --panel2:#202633;
    --text:#e8eef7;
    --muted:#98a2b3;
    --accent:#77c3ff;
    --danger:#ff6b6b;
    --ok:#5ee39c;
    --handle:#ffffffcc;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #app{height:100%;display:flex;flex-direction:column}
  .topbar{
    display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;
    padding:.5rem .75rem;background:linear-gradient(180deg,var(--panel),var(--panel2));
    position:sticky;top:0;z-index:1000;box-shadow:0 2px 10px #0006
  }
  .topbar h1{font-size:1rem;margin:0;margin-right:.5rem;white-space:nowrap;opacity:.9}
  .topbar .sp{flex:1}
  .btn, select, input[type="text"]{
    background:#283041;border:1px solid #3a455b;color:var(--text);padding:.45rem .6rem;border-radius:.6rem;
    font-size:.95rem
  }
  .btn:hover{filter:brightness(1.08)}
  .btn.primary{background:#284a6b;border-color:#356a92}
  .btn.good{background:#1f5a3f;border-color:#2b7a57}
  .btn.danger{background:#5a2323;border-color:#7a2f2f}
  .btn.ghost{background:transparent;border-color:#3a455b}
  .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .label{font-size:.8rem;color:var(--muted)}
  #stage{
    position:relative;flex:1;overflow:hidden;touch-action:none;
    background: radial-gradient(1200px 800px at 50% 30%, #141821 0%, #0f1115 65%, #0b0d12 100%);
  }
  .pad{
    position:absolute;display:flex;align-items:center;justify-content:center;
    user-select:none;touch-action:none;
    border-radius:1rem;border:2px solid #ffffff14;box-shadow:0 10px 30px #0008, inset 0 0 0 2px #0006;
    transition: box-shadow .12s ease, transform .08s ease;
  }
  .pad .label{
    color:#fff;font-weight:700;letter-spacing:.2px;text-shadow:0 2px 6px #000b;pointer-events:none;
  }
  .pad.flash{box-shadow:0 0 0 6px #fff2, 0 10px 30px #0009}
  .handles{position:absolute;inset:-18px;pointer-events:none;opacity:0;transition:opacity .15s}
  .pad.selected .handles{opacity:1}
  .handle{
    position:absolute;width:18px;height:18px;background:var(--handle);border:2px solid #0007;border-radius:50%;
    box-shadow:0 2px 6px #0008;pointer-events:auto;touch-action:none
  }
  .h-nw{left:-18px;top:-18px;cursor:nwse-resize}
  .h-ne{right:-18px;top:-18px;cursor:nesw-resize}
  .h-sw{left:-18px;bottom:-18px;cursor:nesw-resize}
  .h-se{right:-18px;bottom:-18px;cursor:nwse-resize}
  .h-rot{
    left:50%;transform:translateX(-50%);top:-42px;width:22px;height:22px;background:#fff;border-color:#000;cursor:grab
  }
  .h-rot:active{cursor:grabbing}
  .badge{font-size:.75rem;padding:.1rem .4rem;border-radius:.4rem;background:#00000055;border:1px solid #ffffff1a}
  .panel{
    position:fixed;left:8px;bottom:8px;right:8px;z-index:1001;
    display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;
    background:#0b0e14cc;border:1px solid #1f2633;border-radius:1rem;padding:.5rem .6rem;backdrop-filter: blur(6px)
  }
  .panel .section{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
  .sep{width:1px;height:26px;background:#ffffff1a;margin:0 .25rem}
  /* zapobiegaj przewijaniu */
  body, #stage{overscroll-behavior:none}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <h1>Mobile-Drums</h1>
    <div class="row">
      <span class="label">Tryb:</span>
      <button id="modePlay" class="btn good">Odtwarzanie</button>
      <button id="modeEdit" class="btn">Edycja</button>
    </div>
    <div class="row">
      <span class="label">Układ:</span>
      <select id="layoutSelect" title="Wybierz układ"></select>
      <button id="saveBtn" class="btn primary">Zapisz</button>
      <button id="saveAsBtn" class="btn">Zapisz jako…</button>
      <button id="deleteBtn" class="btn danger">Usuń</button>
      <button id="exportBtn" class="btn ghost">Eksport JSON</button>
      <label class="btn ghost" for="importFile">Import JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>
    <div class="sp"></div>
    <div class="row">
      <button id="fullscreenBtn" class="btn">Pełny ekran</button>
      <span class="badge" id="statusBadge">Gotowe</span>
    </div>
  </div>

  <div id="stage"></div>

  <!-- Panel kontekstowy edycji pada -->
  <div id="editPanel" class="panel hidden">
    <div class="section">
      <span class="label">Pad:</span>
      <span id="padId" class="badge">—</span>
    </div>
    <div class="sep"></div>
    <div class="section">
      <span class="label">Etykieta</span>
      <input id="labelInput" type="text" placeholder="np. KICK">
      <button id="colorBtn" class="btn">Kolor</button>
      <input id="colorInput" type="color" style="display:none">
      <button id="soundBtn" class="btn">Dźwięk…</button>
      <input id="fileInput" type="file" accept="audio/*" style="display:none">
    </div>
    <div class="sep"></div>
    <div class="section">
      <button id="dupBtn" class="btn">Duplikuj</button>
      <button id="toFrontBtn" class="btn">Na wierzch</button>
      <button id="toBackBtn" class="btn">Na spód</button>
      <button id="deletePadBtn" class="btn danger">Usuń pad</button>
    </div>
  </div>
</div>

<script>
/* ====== Utilsy ====== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const uid = ()=> 'p' + Math.random().toString(36).slice(2,8);
const STORAGE_KEY = 'MD_LAYOUTS_V2';
const AUTO_KEY = '__AUTO__';
const STATUS = $('#statusBadge');

function setStatus(msg, ok=true){
  STATUS.textContent = msg;
  STATUS.style.background = ok ? '#0f2a1b' : '#2a0f0f';
  STATUS.style.borderColor = ok ? '#1f5a3f' : '#7a2f2f';
}

/* ====== Audio Engine ====== */
class AudioEngine{
  constructor(){
    this.ctx = null;
    this.buffers = new Map(); // id -> AudioBuffer
    this.pendingDecode = new Map(); // id -> Promise
  }
  ensure(){
    if(!this.ctx){
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }
  async playBuffer(buf, vol=1.0){
    this.ensure();
    const src = this.ctx.createBufferSource();
    src.buffer = buf;
    const g = this.ctx.createGain();
    g.gain.value = vol;
    src.connect(g).connect(this.ctx.destination);
    src.start();
  }
  async playFallbackClick(){
    this.ensure();
    // krótki klik generowany syntetycznie
    const sr = this.ctx.sampleRate;
    const len = Math.floor(sr * 0.06);
    const buf = this.ctx.createBuffer(1, len, sr);
    const ch = buf.getChannelData(0);
    for(let i=0;i<len;i++){
      const t = i/sr;
      const env = Math.exp(-40*t);
      ch[i] = (Math.random()*2-1)*0.4*env;
    }
    this.playBuffer(buf, 0.8);
  }
  async decodeAndCache(id, arrayBuf){
    this.ensure();
    if(this.pendingDecode.has(id)) return this.pendingDecode.get(id);
    const p = this.ctx.decodeAudioData(arrayBuf.slice(0)).then(buf=>{
      this.buffers.set(id, buf);
      this.pendingDecode.delete(id);
      return buf;
    }).catch(e=>{
      this.pendingDecode.delete(id);
      throw e;
    });
    this.pendingDecode.set(id,p);
    return p;
  }
  async playPad(pad){
    try{
      if(pad.sound && pad.sound.type==='buffer' && this.buffers.has(pad.id)){
        return this.playBuffer(this.buffers.get(pad.id), pad.volume ?? 1.0);
      }
      if(pad.sound && pad.sound.type==='dataurl'){
        // zdekoduj i zapamiętaj
        const arr = await (await fetch(pad.sound.src)).arrayBuffer();
        const buf = await this.decodeAndCache(pad.id, arr);
        return this.playBuffer(buf, pad.volume ?? 1.0);
      }
      if(pad.sound && pad.sound.type==='url'){
        const resp = await fetch(pad.sound.src);
        const arr = await resp.arrayBuffer();
        const buf = await this.decodeAndCache(pad.id, arr);
        return this.playBuffer(buf, pad.volume ?? 1.0);
      }
      // brak dźwięku → klik
      await this.playFallbackClick();
    }catch(err){
      console.warn('Audio error:', err);
      setStatus('Błąd dźwięku (klik jako fallback)', false);
      this.playFallbackClick();
    }
  }
}
const audio = new AudioEngine();

/* ====== Layout Store ====== */
const Store = {
  all(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch{ return {}; } },
  saveAll(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); },
  list(){ return Object.keys(this.all()).sort((a,b)=> a===AUTO_KEY? -1 : b===AUTO_KEY? 1 : a.localeCompare(b)); },
  get(name){ return this.all()[name] || null; },
  set(name, data){
    const all = this.all(); all[name]=data; this.saveAll(all);
  },
  del(name){
    const all = this.all(); delete all[name]; this.saveAll(all);
  }
};

/* ====== Stage / Pads ====== */
const stage = $('#stage');
let MODE = 'play'; // 'play' | 'edit'
let pads = [];
let activePadId = null;
let dragState = null;
let currentLayoutName = AUTO_KEY;

function createPad(partial={}){
  const p = Object.assign({
    id: uid(),
    label: 'PAD',
    x: 40, y: 60, w: 140, h: 140, rot: 0,
    color: '#3b82f6',
    sound: null, // {type:'dataurl'|'url'|'buffer', src:'...'}
    volume: 1.0,
    z: Date.now()
  }, partial);
  pads.push(p);
  mountPad(p);
  return p;
}

function mountPad(p){
  let el = document.getElementById(p.id);
  if(!el){
    el = document.createElement('div');
    el.id = p.id;
    el.className='pad';
    el.innerHTML = `
      <div class="label"></div>
      <div class="handles">
        <div class="handle h-nw" data-act="scale" data-corner="nw"></div>
        <div class="handle h-ne" data-act="scale" data-corner="ne"></div>
        <div class="handle h-sw" data-act="scale" data-corner="sw"></div>
        <div class="handle h-se" data-act="scale" data-corner="se"></div>
        <div class="handle h-rot" data-act="rotate" title="Obrót"></div>
      </div>
    `;
    stage.appendChild(el);

    // interakcje
    el.addEventListener('pointerdown', e=>{
      if(MODE==='edit'){
        selectPad(p.id);
        const target = e.target;
        if(target.classList.contains('handle')){
          const act = target.dataset.act;
          startTransform(e, p.id, act, target.dataset.corner || null);
        }else{
          startTransform(e, p.id, 'move', null);
        }
      }else{
        triggerPad(p.id);
      }
    });
  }
  renderPad(p);
}

function renderPad(p){
  const el = document.getElementById(p.id);
  if(!el) return;
  el.style.left = p.x+'px';
  el.style.top = p.y+'px';
  el.style.width = p.w+'px';
  el.style.height = p.h+'px';
  el.style.transform = `rotate(${p.rot}deg)`;
  el.style.background = `linear-gradient(180deg, ${shade(p.color,20)} 0%, ${shade(p.color,-10)} 100%)`;
  el.style.zIndex = (p.z||1)+'';

  const lab = el.querySelector('.label');
  lab.textContent = p.label || 'PAD';
  el.classList.toggle('selected', activePadId===p.id && MODE==='edit');
  el.querySelector('.handles').style.pointerEvents = MODE==='edit' ? 'auto':'none';
}

function shade(hex, amt){
  // proste rozjaśnianie/przyciemnianie
  try{
    const c = hex.replace('#','');
    const num = parseInt(c.length===3 ? c.split('').map(ch=>ch+ch).join('') : c,16);
    let r=(num>>16)+amt*2, g=((num>>8)&0xff)+amt*2, b=(num&0xff)+amt*2;
    r=clamp(r,0,255); g=clamp(g,0,255); b=clamp(b,0,255);
    return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
  }catch{ return hex; }
}

function selectPad(id){
  activePadId = id;
  $$('.pad').forEach(el=>el.classList.toggle('selected', el.id===id));
  updateEditPanel();
}
function getPad(id){ return pads.find(p=>p.id===id); }

async function triggerPad(id){
  const p = getPad(id);
  if(!p) return;
  const el = document.getElementById(id);
  el.classList.add('flash');
  setTimeout(()=>el.classList.remove('flash'), 80);
  await audio.playPad(p);
}

/* ====== Transformacje (przesuwanie / skalowanie / obrót) ====== */
function stageRect(){ return stage.getBoundingClientRect(); }

function startTransform(e, id, action, corner){
  e.preventDefault();
  const p = getPad(id);
  if(!p) return;
  const r = stageRect();
  const startX = e.clientX, startY = e.clientY;
  const start = { x: p.x, y: p.y, w:p.w, h:p.h, rot:p.rot };
  dragState = { id, action, corner, startX, startY, start, ox: (p.x+p.w/2), oy:(p.y+p.h/2) };
  stage.setPointerCapture(e.pointerId);
  window.addEventListener('pointermove', onDragMove);
  window.addEventListener('pointerup', onDragEnd, {once:true});
}

function onDragMove(e){
  if(!dragState) return;
  const p = getPad(dragState.id); if(!p) return;
  const dx = e.clientX - dragState.startX;
  const dy = e.clientY - dragState.startY;
  if(dragState.action==='move'){
    p.x = clamp(dragState.start.x + dx, 0, stage.clientWidth - p.w);
    p.y = clamp(dragState.start.y + dy, 0, stage.clientHeight - p.h);
  }else if(dragState.action==='scale'){
    let sx=0, sy=0;
    const corner = dragState.corner;
    // skalowanie bez utrzymania proporcji (celowo – do perkusji bywa wygodne)
    if(corner==='se'){ p.w = clamp(dragState.start.w + dx, 60, 600); p.h = clamp(dragState.start.h + dy, 60, 600); }
    if(corner==='ne'){ p.w = clamp(dragState.start.w + dx, 60, 600); p.y = clamp(dragState.start.y + dy, 0, dragState.start.y+dragState.start.h-60); p.h = dragState.start.h - (p.y - dragState.start.y); }
    if(corner==='sw'){ p.x = clamp(dragState.start.x + dx, 0, dragState.start.x+dragState.start.w-60); p.w = dragState.start.w - (p.x - dragState.start.x); p.h = clamp(dragState.start.h + dy, 60, 600); }
    if(corner==='nw'){ p.x = clamp(dragState.start.x + dx, 0, dragState.start.x+dragState.start.w-60); p.y = clamp(dragState.start.y + dy, 0, dragState.start.y+dragState.start.h-60); p.w = dragState.start.w - (p.x - dragState.start.x); p.h = dragState.start.h - (p.y - dragState.start.y); }
  }else if(dragState.action==='rotate'){
    const cx = p.x + p.w/2, cy = p.y + p.h/2;
    const ang = Math.atan2((e.clientY - (stageRect().top+cy)), (e.clientX - (stageRect().left+cx)));
    p.rot = Math.round((ang*180/Math.PI + 90)); // 0° = w górę
  }
  renderPad(p);
}
function onDragEnd(e){
  if(!dragState) return;
  stage.releasePointerCapture(e.pointerId);
  window.removeEventListener('pointermove', onDragMove);
  // auto-save szkic
  persistAuto();
  dragState = null;
}

/* ====== Edycja – panel i akcje ====== */
const editPanel = $('#editPanel');
const padIdBadge = $('#padId');
const labelInput = $('#labelInput');
const colorBtn = $('#colorBtn');
const colorInput = $('#colorInput');
const soundBtn = $('#soundBtn');
const fileInput = $('#fileInput');
const dupBtn = $('#dupBtn');
const toFrontBtn = $('#toFrontBtn');
const toBackBtn = $('#toBackBtn');
const deletePadBtn = $('#deletePadBtn');

function updateEditPanel(){
  const p = getPad(activePadId);
  if(MODE!=='edit' || !p){ editPanel.classList.add('hidden'); return; }
  editPanel.classList.remove('hidden');
  padIdBadge.textContent = p.label || p.id;
  labelInput.value = p.label || '';
}

labelInput.addEventListener('input', ()=>{
  const p = getPad(activePadId); if(!p) return;
  p.label = labelInput.value.trim().slice(0,24) || 'PAD';
  renderPad(p); persistAuto();
});

colorBtn.addEventListener('click', ()=> colorInput.click());
colorInput.addEventListener('input', ()=>{
  const p = getPad(activePadId); if(!p) return;
  p.color = colorInput.value;
  renderPad(p); persistAuto();
});

soundBtn.addEventListener('click', async ()=>{
  const p = getPad(activePadId); if(!p) return;
  const what = await chooseSound();
  if(!what) return;
  p.sound = what;
  // wyczyść bufor dekodowany dla tego pada (jeśli był)
  audio.buffers.delete(p.id);
  persistAuto();
  setStatus('Dźwięk przypisany');
});

function chooseSound(){
  return new Promise((resolve)=>{
    // mały popup: wybór pliku lub URL
    const wrap = document.createElement('div');
    Object.assign(wrap.style,{position:'fixed',inset:'0',background:'#0008',display:'grid',placeItems:'center',zIndex:2000});
    wrap.innerHTML = `
      <div style="background:#10151f;border:1px solid #2a3446;border-radius:12px; padding:16px; max-width:92vw; width:420px">
        <div style="font-weight:700;margin-bottom:8px">Wybierz źródło dźwięku</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button id="pickFile" class="btn">Plik audio…</button>
          <button id="pickUrl" class="btn ghost">Wklej URL</button>
          <button id="cancelPick" class="btn danger" style="margin-left:auto">Anuluj</button>
        </div>
        <div class="label" style="opacity:.8">Plik zostanie zapisany w układzie (localStorage). URL pozostanie linkiem (wymaga dostępu do sieci).</div>
      </div>
    `;
    document.body.appendChild(wrap);
    wrap.querySelector('#cancelPick').onclick = ()=>{ cleanup(); resolve(null); };
    wrap.querySelector('#pickFile').onclick = ()=>{
      fileInput.onchange = async ()=>{
        const f = fileInput.files[0];
        if(!f){ cleanup(); resolve(null); return; }
        const b64 = await fileToDataURL(f);
        cleanup(); resolve({type:'dataurl', src:b64, name:f.name});
      };
      fileInput.click();
    };
    wrap.querySelector('#pickUrl').onclick = async ()=>{
      const url = prompt('Wklej URL do pliku audio (mp3/wav/ogg):');
      if(!url){ cleanup(); resolve(null); return; }
      cleanup(); resolve({type:'url', src:url});
    };
    function cleanup(){ document.body.removeChild(wrap); }
  });
}
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

dupBtn.addEventListener('click', ()=>{
  const p = getPad(activePadId); if(!p) return;
  const cp = JSON.parse(JSON.stringify(p));
  cp.id = uid();
  cp.x += 24; cp.y += 24; cp.z = Date.now();
  pads.push(cp);
  mountPad(cp); selectPad(cp.id); persistAuto();
});
toFrontBtn.addEventListener('click', ()=>{
  const p = getPad(activePadId); if(!p) return;
  p.z = Date.now(); renderPad(p); persistAuto();
});
toBackBtn.addEventListener('click', ()=>{
  const p = getPad(activePadId); if(!p) return;
  p.z = 1; renderPad(p); persistAuto();
});
deletePadBtn.addEventListener('click', ()=>{
  const p = getPad(activePadId); if(!p) return;
  if(!confirm(`Usunąć pad "${p.label}"?`)) return;
  const el = document.getElementById(p.id);
  if(el) el.remove();
  pads = pads.filter(x=>x.id!==p.id);
  activePadId=null; updateEditPanel(); persistAuto();
});

/* ====== Tryby ====== */
const modePlayBtn = $('#modePlay');
const modeEditBtn = $('#modeEdit');

function setMode(m){
  MODE = m;
  modePlayBtn.classList.toggle('good', m==='play');
  modeEditBtn.classList.toggle('good', m==='edit');
  $$('.pad').forEach(el=>{
    el.classList.toggle('selected', MODE==='edit' && el.id===activePadId);
  });
  editPanel.classList.toggle('hidden', MODE!=='edit' || !activePadId);
  setStatus(MODE==='edit' ? 'Tryb edycji' : 'Tryb odtwarzania');
}
modePlayBtn.addEventListener('click', ()=> setMode('play'));
modeEditBtn.addEventListener('click', ()=> setMode('edit'));

/* ====== Układy (zapisywanie/ładowanie) ====== */
const layoutSelect = $('#layoutSelect');
const saveBtn = $('#saveBtn');
const saveAsBtn = $('#saveAsBtn');
const deleteBtn = $('#deleteBtn');
const exportBtn = $('#exportBtn');
const importFile = $('#importFile');

function refreshLayoutSelect(){
  const names = Store.list();
  layoutSelect.innerHTML = '';
  for(const n of names){
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = (n===AUTO_KEY? 'Bieżący (auto)': n);
    layoutSelect.appendChild(opt);
  }
  layoutSelect.value = currentLayoutName;
}
layoutSelect.addEventListener('change', ()=>{
  const name = layoutSelect.value;
  loadLayout(name);
});

function serialize(){
  return {
    version:2,
    name: currentLayoutName,
    pads: pads.map(p=>({
      id:p.id,label:p.label,x:p.x,y:p.y,w:p.w,h:p.h,rot:p.rot,color:p.color,volume:p.volume,z:p.z,
      sound:p.sound ? {type:p.sound.type, src:p.sound.src, name:p.sound.name||null} : null
    })),
    w: stage.clientWidth, h: stage.clientHeight,
    savedAt: Date.now()
  };
}
function hydrate(data){
  // wyczyść
  stage.innerHTML='';
  pads = [];
  (data.pads||[]).forEach(p=>{ pads.push(p); mountPad(p); });
  activePadId = pads[0]?.id || null;
  updateEditPanel();
  // załaduj bufory audio dźwięków zapisanych jako dataurl (leniwie – przy pierwszym odtworzeniu)
}

function persistAuto(){
  const snap = serialize();
  snap.name = AUTO_KEY;
  Store.set(AUTO_KEY, snap);
  if(currentLayoutName===AUTO_KEY){
    refreshLayoutSelect();
  }
}
function saveLayout(asName=null){
  const name = asName || (currentLayoutName===AUTO_KEY ? prompt('Nazwa układu:','Zestaw_'+new Date().toLocaleTimeString('pl-PL').replace(/[: ]/g,'_')) : currentLayoutName);
  if(!name) return;
  const snap = serialize(); snap.name = name;
  Store.set(name, snap);
  currentLayoutName = name;
  refreshLayoutSelect();
  setStatus(`Zapisano: ${name}`);
}
function loadLayout(name){
  const data = Store.get(name);
  if(!data){ setStatus('Brak układu', false); return; }
  currentLayoutName = name;
  hydrate(data);
  refreshLayoutSelect();
  setStatus(`Załadowano: ${name}`);
}
function deleteLayout(){
  if(currentLayoutName===AUTO_KEY){ alert('Nie można usuwać układu automatycznego.'); return; }
  if(!confirm(`Usunąć układ "${currentLayoutName}"?`)) return;
  Store.del(currentLayoutName);
  currentLayoutName = AUTO_KEY;
  refreshLayoutSelect();
  loadLayout(AUTO_KEY);
}

saveBtn.addEventListener('click', ()=> saveLayout(null));
saveAsBtn.addEventListener('click', ()=> saveLayout('__ASK__'));
deleteBtn.addEventListener('click', ()=> deleteLayout());
exportBtn.addEventListener('click', ()=>{
  const data = serialize();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = (data.name||'uklad')+'.json'; a.click();
  URL.revokeObjectURL(url);
});
importFile.addEventListener('change', async ()=>{
  const f = importFile.files[0]; if(!f) return;
  const text = await f.text();
  try{
    const obj = JSON.parse(text);
    const name = prompt('Nazwa dla importu:', obj.name || 'Import_'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'));
    if(!name) return;
    obj.name = name;
    Store.set(name, obj);
    currentLayoutName = name;
    refreshLayoutSelect();
    loadLayout(name);
    setStatus('Zaimportowano układ');
  }catch(e){
    alert('Nieprawidłowy plik JSON'); setStatus('Błąd importu', false);
  }finally{
    importFile.value='';
  }
});

/* ====== Fullscreen ====== */
$('#fullscreenBtn').addEventListener('click', async ()=>{
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
    }else{
      await document.exitFullscreen();
    }
  }catch(e){
    // iOS Safari nie pozwala programowo – podpowiedź
    alert('Jeśli przeglądarka nie zezwala na fullscreen: na iOS dodaj do ekranu głównego, na Androidzie użyj „Dodaj do ekranu głównego”.');
  }
});

/* ====== Inicjalizacja i predef układu ====== */
function defaultLayout(){
  const vw = stage.clientWidth, vh = stage.clientHeight;
  // 6 padów startowych
  const S = Math.min(vw, vh);
  const base = Math.max(100, Math.min(180, Math.floor(S/4)));
  return [
    {label:'KICK', x:20, y:vh-base-20, w:base, h:base, color:'#2563eb'},
    {label:'SNARE', x:40+base, y:vh-base-20, w:base, h:base, color:'#ef4444'},
    {label:'HH', x:60+2*base, y:vh-base-20, w:base, h:base, color:'#eab308'},
    {label:'TOM1', x:20, y:20, w:base, h:base, color:'#22c55e'},
    {label:'TOM2', x:40+base, y:20, w:base, h:base, color:'#a855f7'},
    {label:'CRASH', x:60+2*base, y:20, w:base, h:base, color:'#06b6d4'},
  ];
}

function init(){
  // zablokuj scroll/gesty pinch-zoom
  document.addEventListener('gesturestart', e=>e.preventDefault());
  document.addEventListener('gesturechange', e=>e.preventDefault());
  document.addEventListener('touchmove', e=>{
    if(!e.target.closest('.pad')) e.preventDefault();
  }, {passive:false});

  // Wczytaj auto albo stwórz domyślny
  const auto = Store.get(AUTO_KEY);
  if(auto && auto.pads && auto.pads.length){
    hydrate(auto);
  }else{
    defaultLayout().forEach(cfg=> createPad(cfg));
    persistAuto();
  }
  currentLayoutName = AUTO_KEY;
  refreshLayoutSelect();
  setMode('play');

  // klik pustego obszaru w trybie edycji – dodaje pad
  stage.addEventListener('dblclick', e=>{
    if(MODE!=='edit') return;
    const rect = stageRect();
    const x = e.clientX - rect.left, y= e.clientY - rect.top;
    const p = createPad({label:'NEW', x:x-60, y:y-60, w:140, h:140, color:'#64748b'});
    selectPad(p.id); persistAuto();
  });

  // Klawiszologia (desktop)
  window.addEventListener('keydown', e=>{
    if(MODE==='edit' && activePadId){
      const p = getPad(activePadId);
      const step = e.shiftKey ? 10 : 2;
      if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Delete'].includes(e.key)) e.preventDefault();
      if(e.key==='ArrowLeft'){ p.x = clamp(p.x-step,0,stage.clientWidth-p.w); renderPad(p); persistAuto(); }
      if(e.key==='ArrowRight'){ p.x = clamp(p.x+step,0,stage.clientWidth-p.w); renderPad(p); persistAuto(); }
      if(e.key==='ArrowUp'){ p.y = clamp(p.y-step,0,stage.clientHeight-p.h); renderPad(p); persistAuto(); }
      if(e.key==='ArrowDown'){ p.y = clamp(p.y+step,0,stage.clientHeight-p.h); renderPad(p); persistAuto(); }
      if(e.key==='Delete'){ deletePadBtn.click(); }
      if(e.key==='r'){ p.rot = (p.rot+15)%360; renderPad(p); persistAuto(); }
    }
    // Szybkie przełączanie trybu
    if(e.key==='e'){ setMode(MODE==='edit'?'play':'edit'); }
  });

  window.addEventListener('resize', ()=>{
    // nic nie skalujemy globalnie — zostawiamy użytkownikowi pełną kontrolę
  });
}

/* ====== Start ====== */
init();
</script>
</body>
</html>
