<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Drum Pad</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0d10">
<style>
:root{
  --bg:#0b0d10; --text:#e6edf3; --muted:#9aa4ad;
  --pad:#1b1f24; --pad2:#14181d; --pad-active:#2d333b; --accent:#4aa3ff;
  --topbar-h:52px;
  --size-min:84px; --size-vw:28vw; --size-max:160px;
  --btn-bg:#12161b; --btn-br:#2b3138; --btn-glow:rgba(74,163,255,.35);
}
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-tap-highlight-color:transparent; touch-action:manipulation;
}
body, #app{min-height:100svh}

/* Top bar */
.topbar{
  position:fixed;top:0;left:0;right:0;z-index:90;height:var(--topbar-h);
  display:flex;align-items:center;gap:.6rem;
  padding:0 .6rem env(safe-area-inset-right,12px) env(safe-area-inset-left,12px);
  background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));
}
.title{font-weight:800;letter-spacing:.4px;margin-left:.2rem}
.muted{color:var(--muted);font-size:.9rem}
.badge{font-size:.85rem;color:var(--muted);padding:.1rem .4rem;border:1px solid var(--btn-br);border-radius:.5rem;background:#0e1116}

/* Przycisk – jeden system dla wszystkich wariantów */
.btn, select, input[type="text"]{
  appearance:none;cursor:pointer;font-weight:700;color:var(--text);
  background:var(--btn-bg);border:1px solid var(--btn-br);border-radius:.6rem;
  padding:.5rem .8rem;display:inline-flex;align-items:center;gap:.45rem;
  box-shadow:0 0 0 1px rgba(255,255,255,.02) inset, 0 4px 16px rgba(0,0,0,.32);
}
.btn:active{transform:scale(.98)}
.btn.ghost{background:transparent}
.btn.danger{background:#301919;border-color:#7a2f2f}
.btn.primary{background:#142231;border-color:#356a92}
.btn.toggle{position:relative}
.btn.toggle[data-on="1"]{outline:2px solid var(--accent); box-shadow:0 0 0 3px rgba(74,163,255,.13)}
select{cursor:pointer}

/* Neon – identycznie dla wszystkich typów */
body.theme-neon{
  --bg:#070910; --text:#e9f6ff; --muted:#9cc7ff;
  --pad:#0b1020; --pad2:#0a0e1a; --pad-active:#111a33; --accent:#00e5ff;
  --btn-bg:#0a1121; --btn-br:#123154; --btn-glow:rgba(0,229,255,.45);
}
body.theme-neon .btn, body.theme-neon select, body.theme-neon input[type="text"]{
  box-shadow:0 0 10px var(--btn-glow), 0 8px 24px rgba(0,0,0,.35), inset 0 2px 0 rgba(0,0,0,.55);
  text-shadow:0 0 6px rgba(0,229,255,.25);
}
body.theme-neon .btn.toggle[data-on="1"]{outline:2px solid var(--accent); box-shadow:0 0 14px var(--btn-glow), 0 0 0 3px rgba(0,229,255,.15)}

/* Scena */
#stage{
  position:fixed;
  top:calc(var(--topbar-h) + 4px);
  left:0;right:0;
  bottom:calc(env(safe-area-inset-bottom,0px) + 6px);
  padding:.8rem;overflow:hidden;touch-action:manipulation;
}
.grid{
  display:grid;gap:.8rem;
  grid-template-columns:repeat(auto-fit,minmax(clamp(var(--size-min), var(--size-vw), var(--size-max)),1fr));
  grid-auto-rows:minmax(clamp(72px,16vh,180px),1fr);align-content:start
}
.canvas{position:relative}
.canvas .pad{position:absolute;touch-action:none}

/* Pady */
.pad{
  background:var(--pad);border:1px solid #2b3138;border-radius:1rem;
  display:flex;align-items:center;justify-content:center;text-align:center;
  padding:.45rem;user-select:none;-webkit-user-select:none;font-weight:800;letter-spacing:.3px;
  box-shadow:0 2px 0 rgba(0,0,0,.5) inset,0 6px 18px rgba(0,0,0,.25);
  touch-action:none;font-size:16px; color:#fff;
}
.pad.active{
  background:var(--pad-active);outline:2px solid var(--accent);
  box-shadow:0 0 0 4px rgba(74,163,255,.15),0 10px 28px rgba(0,0,0,.4) inset;
  transform:scale(.99)
}
.pad.dragging{opacity:.95;outline:2px dashed var(--accent)}
.shape-circle{border-radius:999px}
.shape-rect{border-radius:1rem}
.shape-hex{clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%)}
.shape-tri{clip-path:polygon(50% 0%,0% 100%,100% 100%)}
.shape-drum{clip-path:path("M10,50 C10,20 90,20 90,50 C90,80 10,80 10,50 Z");border-radius:0}

/* Kolory kategorii (jak było) */
.c-kick{background:radial-gradient(120% 120% at 30% 30%,#2a3a20,#1c2416 70%)}
.c-snare{background:radial-gradient(120% 120% at 30% 30%,#2b2e3a,#171a21 70%)}
.c-hats{background:radial-gradient(120% 120% at 30% 30%,#27333d,#151c22 70%)}
.c-toms{background:radial-gradient(120% 120% at 30% 30%,#2d3131,#171a1a 70%)}
.c-cym{background:radial-gradient(120% 120% at 30% 30%,#303227,#181a12 70%)}
.c-hand{background:radial-gradient(120% 120% at 30% 30%,#2a2e38,#151922 70%)}
.c-fun{background:radial-gradient(120% 120% at 30% 30%,#3a2a2a,#211515 70%)}

/* Menu panel */
#menuPanel{
  position:fixed;inset:0;z-index:100;display:none;
  background:rgba(0,0,0,.72);backdrop-filter:saturate(1.2) blur(6px);
  padding:calc(env(safe-area-inset-top,0) + 64px) 14px calc(env(safe-area-inset-bottom,0) + 14px);
  color:var(--text)
}
.menu-card{
  margin:0 auto;max-width:720px;background:#0e1116;border:1px solid #2b3138;border-radius:1rem;
  padding:.9rem
}
.menu-section{border-top:1px solid #212832;margin-top:.7rem;padding-top:.7rem}
.menu-row{display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap}
.menu-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.7rem}

/* Pasek Układu */
#layoutBar{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(10px + env(safe-area-inset-bottom,0));
  z-index:95;display:none;gap:.5rem
}

/* Start overlay */
#tapStart{
  position:fixed;inset:0;z-index:120;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;
  padding:2rem;text-align:center;color:var(--text);background:rgba(0,0,0,.86)
}
#tapStart .big{font-size:1.25rem;font-weight:800}
#tapStart .hint{opacity:.8}

/* Przyciski na pasku */
.iconbtn{
  appearance:none;cursor:pointer;border:1px solid var(--btn-br);border-radius:.6rem;
  background:var(--btn-bg);color:var(--text);padding:.5rem .8rem;display:flex;align-items:center;gap:.4rem
}
.icon{width:18px;height:2px;background:currentColor;position:relative;display:inline-block}
.icon::before,.icon::after{content:"";position:absolute;left:0;right:0;height:2px;background:currentColor}
.icon::before{top:-6px}.icon::after{top:6px}

/* Chrome hidden */
body.chrome-hidden .topbar{display:none}
#hambit{
  position:fixed;z-index:92;top:8px;left:8px;
  padding:.5rem .6rem;border-radius:.6rem;border:1px solid var(--btn-br);background:var(--btn-bg);color:var(--text);
  display:none
}
body.chrome-hidden #hambit{display:flex}

/* Panel edycji pada */
#editPanel{
  position:fixed;left:8px;right:8px;bottom:8px;z-index:96;display:none;
  background:#0b0e14cc;border:1px solid #1f2633;border-radius:1rem;padding:.5rem .6rem;backdrop-filter: blur(6px)
}
#editPanel .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
.pad.selected{outline:2px solid var(--accent)}
.handle{position:absolute;width:16px;height:16px;background:#fff;border:2px solid #0007;border-radius:50%;box-shadow:0 2px 6px #0008;touch-action:none}
.h-nw{left:-10px;top:-10px;cursor:nwse-resize}
.h-ne{right:-10px;top:-10px;cursor:nesw-resize}
.h-sw{left:-10px;bottom:-10px;cursor:nesw-resize}
.h-se{right:-10px;bottom:-10px;cursor:nwse-resize}
.h-rot{left:50%;top:-36px;transform:translateX(-50%);width:20px;height:20px;cursor:grab}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <button id="menuBtn" class="iconbtn" title="Menu"><span class="icon" aria-hidden="true"></span></button>
    <div class="title">Drum Pad</div>
    <div class="muted">dotknij pad, by grać</div>
    <div style="margin-left:auto" class="badge">BPM: <span id="bpmTopVal">100</span></div>
  </div>

  <button id="hambit" class="iconbtn" title="Menu"><span class="icon"></span></button>

  <div id="tapStart">
    <div class="big">Dotknij, aby rozpocząć</div>
    <button id="tapStartBtn" class="btn primary">Start audio</button>
    <div class="hint">iOS wymaga dotknięcia ekranu, by włączyć dźwięk</div>
  </div>

  <div id="stage" class="grid"></div>

  <!-- Pasek akcji Układ -->
  <div id="layoutBar">
    <button id="layoutSave" class="btn primary">Zapisz</button>
    <button id="layoutCancel" class="btn ghost">Anuluj</button>
  </div>

  <!-- MENU -->
  <div id="menuPanel" aria-hidden="true">
    <div class="menu-card">
      <div class="menu-section">
        <div class="menu-row"><strong>Ustawienia</strong><span class="badge">wybierz i „OK”</span></div>
      </div>

      <div class="menu-section">
        <div class="menu-row">
          <div>Zestaw</div>
          <div>
            <select id="kitSelect" class="btn"></select>
            <button id="customBtn" class="btn">Własne…</button>
          </div>
        </div>
        <div class="menu-row">
          <div>Układ</div>
          <div>
            <button id="layoutStart" class="btn">START</button>
            <button id="layoutUseBtn" class="btn toggle" data-on="0">Użyj mojego układu</button>
          </div>
        </div>
      </div>

      <div class="menu-section">
        <div class="menu-row">
          <div>Metronom</div>
          <div>
            <button id="metroBtn" class="btn toggle" data-on="0">Metro</button>
            <label class="badge">BPM: <span id="bpmVal">100</span></label>
            <input id="bpm" type="range" min="40" max="220" step="1" value="100">
          </div>
        </div>
        <div class="menu-row">
          <div>Neon</div>
          <div><button id="themeBtn" class="btn toggle" data-on="0">Neon</button></div>
        </div>
        <div class="menu-row">
          <div>Rozmiar padów</div>
          <div><input id="size" type="range" min="80" max="130" step="1" value="100"></div>
        </div>
        <div class="menu-row">
          <div>Głośność</div>
          <div><input id="volume" type="range" min="0" max="1" step="0.01" value="0.9"></div>
        </div>
      </div>

      <div class="menu-actions">
        <button id="menuCancel" class="btn ghost">Anuluj</button>
        <button id="menuOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Panel własnych dźwięków (bez zmian) -->
  <div id="customPanel" class="menu-card" style="display:none;position:fixed;inset:10% 5%;z-index:110;overflow:auto">
    <h3>Własny zestaw</h3>
    <div class="badge">Dodaj do 12 plików (WAV/MP3/OGG) — wczytane tylko na czas sesji.</div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.5rem 0 .6rem">
      <input id="fileInput" type="file" accept="audio/*" multiple>
      <button id="loadFiles" class="btn">Wczytaj</button>
    </div>
    <div id="customList"></div>
    <div class="menu-actions">
      <button id="customExport" class="btn">Eksport mapy (JSON)</button>
      <button id="customCancel" class="btn ghost">Zamknij</button>
      <button id="customOk" class="btn primary">Użyj zestawu</button>
    </div>
  </div>

  <!-- Panel edycji pada -->
  <div id="editPanel">
    <div class="row">
      <span class="badge">Pad:</span>
      <strong id="epLabel">—</strong>
      <input id="inpLabel" type="text" placeholder="etykieta" class="btn" style="min-width:140px">
      <button id="btnColor" class="btn">Kolor</button>
      <input id="inpColor" type="color" style="display:none">
      <button id="btnFront" class="btn">Na wierzch</button>
      <button id="btnBack" class="btn">Na spód</button>
      <button id="btnDup" class="btn">Duplikuj</button>
      <button id="btnDel" class="btn danger">Usuń</button>
    </div>
  </div>
</div>

<script>
/* ==== AUDIO CORE (jak było w Twoim) ==== */
let ctx=null, master=null, volumeNode=null, started=false;
const vol=document.getElementById('volume');
function initAudio(){ if(ctx) return;
  const AC=window.AudioContext||window.webkitAudioContext;
  ctx=new AC({latencyHint:'interactive'});
  master=ctx.createGain(); volumeNode=ctx.createGain();
  master.connect(volumeNode).connect(ctx.destination);
  volumeNode.gain.value=parseFloat(vol.value);
  const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master); o.start(); o.stop(ctx.currentTime+0.02);
}
async function ensureRunning(){
  if(!ctx) initAudio();
  if(ctx.state==='suspended' || ctx.state==='interrupted'){ try{ await ctx.resume(); }catch{} }
}
async function startAudio(){
  initAudio(); await ensureRunning();
  started=true; tapStart.style.display='none';
}
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') ensureRunning(); });
window.addEventListener('pageshow', ()=> ensureRunning() );

function noiseBuffer(){ const len=Math.floor(ctx.sampleRate*2.0), b=ctx.createBuffer(1,len,ctx.sampleRate), d=b.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; return b; }
const sharedNoise=(()=>{let _b=null;return()=>_b||(_b=noiseBuffer())})();

const now=()=>ctx?ctx.currentTime:0;
/* ==== SYNTHS (wklej tu swoje S[...] z oryginału) ==== */
const S = {
  // …tu wklej Twój *pełny* blok S z pierwotnego pliku…
  // przy braku – zostaw przykładowe:
  kick: (t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(160,t); o.frequency.exponentialRampToValueAtTime(40,t+.14); g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(1,t+.01); g.gain.exponentialRampToValueAtTime(0.001,t+.18); o.connect(g).connect(master); o.start(t); o.stop(t+.25); },
  snare:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200; const g=ctx.createGain(); g.gain.value=.6; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.12); },
  hatClosed:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; const g=ctx.createGain(); g.gain.value=.35; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.06); },
  hatOpen:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; const g=ctx.createGain(); g.gain.value=.3; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.25); },
  tomLow:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(130,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.9,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.4); o.connect(g).connect(master); o.start(t); o.stop(t+.5); },
  tomHigh:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(190,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.9,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.3); o.connect(g).connect(master); o.start(t); o.stop(t+.4); },
  clap:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const g=ctx.createGain(); g.gain.value=.6; src.connect(g).connect(master); src.start(t); src.stop(t+.1); },
  crash:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000; const g=ctx.createGain(); g.gain.value=.4; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.7); },
  ride:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3500; const g=ctx.createGain(); g.gain.value=.25; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.6); },
  rim:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(900,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.7,t+.005); g.gain.exponentialRampToValueAtTime(.0001,t+.08); o.connect(g).connect(master); o.start(t); o.stop(t+.1); },
  perc:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(400,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.8,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.12); o.connect(g).connect(master); o.start(t); o.stop(t+.18); },
  kick808:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(80,t); o.frequency.exponentialRampToValueAtTime(38,t+.28); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(1,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.6); o.connect(g).connect(master); o.start(t); o.stop(t+.75); },
};
const HAND={hand1:146.83,hand2:220.00,hand3:261.63,hand4:293.66,hand5:329.63,hand6:349.23,hand7:392.00,hand8:440.00,hand9:523.25};

const SHAPE={circle:new Set(['crash','ride','hatClosed','hatOpen','hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9']),
             hex:new Set(['tomHigh','tomLow','hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9']),
             tri:new Set(['perc','rim','clap']),
             drum:new Set(['kick','kick808']),
             rect:new Set(['snare','clap'])};
const COLOR={kick:new Set(['kick','kick808']),
             snare:new Set(['snare','clap']),
             hats:new Set(['hatClosed','hatOpen']),
             toms:new Set(['tomHigh','tomLow']),
             cym:new Set(['crash','ride']),
             hand:new Set(['hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9']),
             fun:new Set(['perc','rim'])};
function shapeClass(id){if(SHAPE.circle.has(id))return'shape-circle';if(SHAPE.hex.has(id))return'shape-hex';if(SHAPE.tri.has(id))return'shape-tri';if(SHAPE.drum.has(id))return'shape-drum';return'shape-rect';}
function colorClass(id){if(COLOR.kick.has(id))return'c-kick';if(COLOR.snare.has(id))return'c-snare';if(COLOR.hats.has(id))return'c-hats';if(COLOR.toms.has(id))return'c-toms';if(COLOR.cym.has(id))return'c-cym';if(COLOR.hand.has(id))return'c-hand';if(COLOR.fun.has(id))return'c-fun';return'';}

const KITS={
  "Standard": ['kick808','snare','hatClosed','hatOpen','tomLow','tomHigh','clap','crash','ride','rim','perc','kick'],
  "Handpan":  ['hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9'],
};

/* ======= SCENA / LAYOUT ======= */
const stage=document.getElementById('stage');
let currentKit=localStorage.getItem('kitName')||'Standard';
let layoutMode=false;
const positionsKey=()=> 'padPositions:'+currentKit;
const layoutUseKey='useCanvasLayout';
let useCanvasLayout = localStorage.getItem(layoutUseKey)==='1';

let draftPositions=null;
const layoutBar=document.getElementById('layoutBar');
const layoutSave=document.getElementById('layoutSave');
const layoutCancel=document.getElementById('layoutCancel');

function getSavedPositions(){ return JSON.parse(localStorage.getItem(positionsKey())||'{}'); }
function setSavedPositions(obj){ localStorage.setItem(positionsKey(), JSON.stringify(obj||{})); }

/* Domyślne pozycje (%) gdy włączony Canvas, a brak zapisanych */
function defaultPositionsForKit(list){
  const out={};
  const cols=3, rows=Math.ceil(list.length/cols);
  const cellW= (100-8)/cols;  // 2% marginesy
  const cellH= (100-8)/Math.max(rows,2);
  list.forEach((id,i)=>{
    const c=i%cols, r=Math.floor(i/cols);
    out[id]={left:2 + c*cellW, top:2 + r*cellH, w:cellW-2, h:cellH-4, rot:0, label:id.toUpperCase(), color:null, z:i+1};
  });
  return out;
}

function renderPads(){
  const kitList = (KITS[currentKit]||[]).slice(0,12);
  const saved = getSavedPositions();
  const haveLayout = Object.keys(saved).length>0;
  const playCanvas = (!layoutMode && useCanvasLayout) ? true : layoutMode; // wymuś Canvas gdy ON
  stage.className = playCanvas ? 'canvas' : 'grid';
  stage.innerHTML='';

  const P = layoutMode ? (draftPositions||{}) : (haveLayout ? saved : defaultPositionsForKit(kitList));

  if(stage.className==='grid'){
    // Siatka klasyczna
    kitList.forEach(id=>{
      const el=document.createElement('div');
      el.className=`pad ${shapeClass(id)} ${colorClass(id)}`;
      el.dataset.sound=id;
      el.textContent=(saved[id]?.label)||id.toUpperCase();
      stage.appendChild(el);
    });
  }else{
    // Canvas (pozycje w %)
    kitList.forEach((id,idx)=>{
      const cfg=P[id]||defaultPositionsForKit([id])[id];
      const el=document.createElement('div');
      el.className=`pad ${shapeClass(id)} ${colorClass(id)}`;
      el.dataset.sound=id;
      el.style.position='absolute';
      el.style.left=(cfg.left??2)+'%';
      el.style.top=(cfg.top??2)+'%';
      el.style.width=(cfg.w??30)+'%';
      el.style.height=(cfg.h??18)+'%';
      el.style.transform=`rotate(${cfg.rot||0}deg)`;
      el.style.zIndex=String(cfg.z||1);
      if(cfg.color) el.style.background=cfg.color;
      el.textContent=(cfg.label)||id.toUpperCase();

      if(layoutMode){
        el.addEventListener('pointerdown', (e)=>selectPad(el, e));
        addHandles(el);
        makeDraggable(el, true);
      }else{
        el.addEventListener('pointerdown',(e)=>{ e.preventDefault(); padDown(el);},{passive:false});
        el.addEventListener('touchstart',(e)=>{ padDown(el);},{passive:true});
      }
      stage.appendChild(el);
    });
  }

  // pasek
  layoutBar.style.display = layoutMode ? 'flex' : 'none';
  document.getElementById('editPanel').style.display = (layoutMode && selectedPadEl)?'block':(layoutMode?'block':'none');

  // Po przełączeniu z edycji do gry usuń uchwyty
  if(!layoutMode){ clearSelectionAndHandles(); }
}

/* TRYB UKŁAD */
function enterLayout(){
  layoutMode=true;
  draftPositions = structuredClone(getSavedPositions());
  selectedPadEl = null;
  renderPads();
}
function exitLayout(save){
  if(save){ setSavedPositions(draftPositions); }
  layoutMode=false; draftPositions=null; selectedPadEl=null;
  clearSelectionAndHandles();
  renderPads();
}
layoutSave.onclick = ()=> exitLayout(true);
layoutCancel.onclick = ()=> exitLayout(false);

/* GRANIE */
function padDown(el){
  const id = el.dataset.sound;
  if(!ctx) initAudio();
  if(!started || (ctx && (ctx.state==='suspended' || ctx.state==='interrupted'))) { startAudio(); }
  S[id]?.();
  el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),120);
}

/* DRAG + SCALE + ROTATE */
function stageRect(){ return stage.getBoundingClientRect(); }

function makeDraggable(el){
  let sx=0,sy=0,sl=0,st=0,drag=false;
  const down=(ev)=>{ if(!layoutMode) return;
    drag=true; el.classList.add('dragging');
    const R=stage.getBoundingClientRect(), P=el.getBoundingClientRect();
    sl=((P.left-R.left)/R.width)*100; st=((P.top-R.top)/R.height)*100;
    sx=ev.clientX||(ev.touches&&ev.touches[0].clientX); sy=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    addEventListener('pointermove',move); addEventListener('pointerup',up,{once:true});
    addEventListener('touchmove',move,{passive:false}); addEventListener('touchend',up,{once:true});
  };
  const move=(ev)=>{ if(!drag) return; ev.preventDefault?.();
    const x=ev.clientX||(ev.touches&&ev.touches[0].clientX), y=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    const R=stage.getBoundingClientRect(); const dx=((x-sx)/R.width)*100, dy=((y-sy)/R.height)*100;
    const L=Math.min(98,Math.max(0,sl+dx)), T=Math.min(98,Math.max(0,st+dy));
    el.style.left=L+'%'; el.style.top=T+'%';
  };
  const up=()=>{ drag=false; el.classList.remove('dragging');
    removeEventListener('pointermove',move); removeEventListener('touchmove',move);
    savePadRect(el);
  };
  el.addEventListener('pointerdown',down); el.addEventListener('touchstart',down,{passive:true});
}

function addHandles(el){
  el.querySelectorAll('.handle').forEach(h=>h.remove());
  ['nw','ne','sw','se','rot'].forEach(pos=>{
    const h=document.createElement('div');
    h.className='handle h-'+pos;
    el.appendChild(h);
    h.addEventListener('pointerdown',(e)=>startTransform(e, el, pos));
    h.addEventListener('touchstart',(e)=>startTransform(e, el, pos),{passive:true});
  });
}

let selectedPadEl=null;
function selectPad(el, e){
  e?.preventDefault?.();
  selectedPadEl = el;
  document.querySelectorAll('.pad').forEach(p=>p.classList.toggle('selected', p===el));
  updateEditPanelFromEl(el);
}

function startTransform(e, el, type){
  if(!layoutMode) return;
  e.preventDefault?.();
  const R=stageRect(), P=el.getBoundingClientRect();
  const start={
    l:((P.left-R.left)/R.width)*100,
    t:((P.top-R.top)/R.height)*100,
    w:(P.width/R.width)*100,
    h:(P.height/R.height)*100,
    rot: getRotationFromTransform(el.style.transform)||0
  };
  const sx=e.clientX||(e.touches&&e.touches[0].clientX);
  const sy=e.clientY||(e.touches&&e.touches[0].clientY);

  const move=(ev)=>{
    const x=ev.clientX||(ev.touches&&ev.touches[0].clientX), y=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    const dx=((x-sx)/R.width)*100, dy=((y-sy)/R.height)*100;
    if(type==='rot'){
      const cx = (el.getBoundingClientRect().left - R.left) + el.getBoundingClientRect().width/2;
      const cy = (el.getBoundingClientRect().top - R.top) + el.getBoundingClientRect().height/2;
      const ang = Math.atan2((y - (R.top+cy)), (x - (R.left+cx)));
      const deg = Math.round((ang*180/Math.PI + 90));
      el.style.transform=`rotate(${deg}deg)`;
    }else{
      let l=start.l, t=start.t, w=start.w, h=start.h;
      if(type==='se'){ w = clampPc(start.w + dx); h = clampPc(start.h + dy); }
      if(type==='ne'){ w = clampPc(start.w + dx); h = clampPc(start.h - dy); t = clampPc(start.t + dy); }
      if(type==='sw'){ w = clampPc(start.w - dx); h = clampPc(start.h + dy); l = clampPc(start.l + dx); }
      if(type==='nw'){ w = clampPc(start.w - dx); h = clampPc(start.h - dy); l = clampPc(start.l + dx); t = clampPc(start.t + dy); }
      el.style.left=l+'%'; el.style.top=t+'%'; el.style.width=w+'%'; el.style.height=h+'%';
    }
    updateEditPanelFromEl(el,true);
  };
  const up=()=>{
    removeEventListener('pointermove',move); removeEventListener('pointerup',up);
    removeEventListener('touchmove',move); removeEventListener('touchend',up);
    savePadRect(el);
  };
  addEventListener('pointermove',move); addEventListener('pointerup',up,{once:true});
  addEventListener('touchmove',move,{passive:false}); addEventListener('touchend',up,{once:true});
}
function clampPc(v){ return Math.min(98, Math.max(2, v)); }
function getRotationFromTransform(tr){
  const m = /rotate\(([-\d.]+)deg\)/.exec(tr||''); return m? parseFloat(m[1]) : 0;
}
function savePadRect(el){
  if(!draftPositions) draftPositions={};
  const id=el.dataset.sound;
  const R=stageRect(), P=el.getBoundingClientRect();
  draftPositions[id] = Object.assign(draftPositions[id]||{}, {
    left: ((P.left-R.left)/R.width)*100,
    top:  ((P.top-R.top)/R.height)*100,
    w:    (P.width/R.width)*100,
    h:    (P.height/R.height)*100,
    rot:  getRotationFromTransform(el.style.transform)||0,
    label: el.textContent.trim(),
    color: el.style.background||null,
    z: parseInt(el.style.zIndex||'1',10)
  });
}

/* EDIT PANEL */
const editPanel = document.getElementById('editPanel');
const epLabel = document.getElementById('epLabel');
const inpLabel = document.getElementById('inpLabel');
const btnColor = document.getElementById('btnColor');
const inpColor = document.getElementById('inpColor');
const btnFront = document.getElementById('btnFront');
const btnBack = document.getElementById('btnBack');
const btnDup = document.getElementById('btnDup');
const btnDel = document.getElementById('btnDel');

function updateEditPanelFromEl(el, live=false){
  if(!layoutMode || !el){ editPanel.style.display='none'; return; }
  editPanel.style.display='block';
  const id = el.dataset.sound;
  epLabel.textContent = id;
  if(!live){
    inpLabel.value = el.textContent.trim();
    // kolor wejściowego pickera ustawiamy tylko gdy to kolor heks
    const c = (el.style.background||'').trim();
    if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)) inpColor.value=c;
  }
}
inpLabel.addEventListener('input', ()=>{
  if(!selectedPadEl) return;
  selectedPadEl.textContent = inpLabel.value.trim() || selectedPadEl.dataset.sound.toUpperCase();
  savePadRect(selectedPadEl);
});
btnColor.addEventListener('click', ()=> inpColor.click());
inpColor.addEventListener('input', ()=>{
  if(!selectedPadEl) return;
  selectedPadEl.style.background = inpColor.value;
  savePadRect(selectedPadEl);
});
btnFront.addEventListener('click', ()=>{
  if(!selectedPadEl) return;
  selectedPadEl.style.zIndex = String(Date.now()%2147483647);
  savePadRect(selectedPadEl);
});
btnBack.addEventListener('click', ()=>{
  if(!selectedPadEl) return;
  selectedPadEl.style.zIndex = '1';
  savePadRect(selectedPadEl);
});
btnDup.addEventListener('click', ()=>{
  if(!selectedPadEl) return;
  const R=stageRect(), P=selectedPadEl.getBoundingClientRect();
  const ghost = selectedPadEl.cloneNode(true);
  const left=((P.left-R.left)/R.width)*100 + 4;
  const top =((P.top -R.top )/R.height)*100 + 4;
  ghost.style.left=left+'%'; ghost.style.top=top+'%';
  ghost.style.zIndex = String(Date.now()%2147483647);
  stage.appendChild(ghost);
  addHandles(ghost); makeDraggable(ghost,true);
});
btnDel.addEventListener('click', ()=>{
  if(!selectedPadEl) return;
  const id = selectedPadEl.dataset.sound;
  selectedPadEl.remove();
  if(draftPositions && draftPositions[id]) delete draftPositions[id];
  selectedPadEl=null;
  editPanel.style.display='block';
});

/* MENU / TOGGLE / BPM */
const menuBtn=document.getElementById('menuBtn');
const hambit=document.getElementById('hambit');
const menuPanel=document.getElementById('menuPanel');
const menuOk=document.getElementById('menuOk');
const menuCancel=document.getElementById('menuCancel');
const kitSelect=document.getElementById('kitSelect');
const layoutStart=document.getElementById('layoutStart');
const layoutUseBtn=document.getElementById('layoutUseBtn');
const sizeEl=document.getElementById('size');
const themeBtn=document.getElementById('themeBtn');
const bpmEl=document.getElementById('bpm');
const bpmVal=document.getElementById('bpmVal');
const bpmTopVal=document.getElementById('bpmTopVal');

function setToggle(btn, on){ btn.dataset.on = on ? '1':'0'; }
function isOn(btn){ return btn.dataset.on === '1'; }

function fillKits(){
  kitSelect.innerHTML='';
  Object.keys(KITS).forEach(k=>{
    const o=document.createElement('option'); o.value=k; o.textContent=k; if(k===currentKit) o.selected=true; kitSelect.appendChild(o);
  });
}
function openMenu(){ fillKits(); applyUseBtn(); menuPanel.style.display='block'; menuPanel.setAttribute('aria-hidden','false'); document.body.classList.remove('chrome-hidden'); }
function closeMenu(){ menuPanel.style.display='none'; menuPanel.setAttribute('aria-hidden','true'); }
function hideChrome(){ document.body.classList.add('chrome-hidden'); }
menuBtn.onclick = openMenu;
hambit.onclick = openMenu;
menuCancel.onclick = ()=>{ closeMenu(); hideChrome(); clearSelectionAndHandles(); renderPads(); };
menuOk.onclick = ()=>{
  const chosen = kitSelect.value;
  if(chosen && chosen!==currentKit){ currentKit=chosen; localStorage.setItem('kitName', currentKit); }
  // wyjście z ewentualnej edycji
  if(layoutMode){ exitLayout(true); }
  clearSelectionAndHandles();
  renderPads();
  closeMenu(); hideChrome();
};

layoutStart.onclick = ()=>{ closeMenu(); enterLayout(); };

function applyTheme(t){ document.body.classList.toggle('theme-neon', t==='neon'); setToggle(themeBtn, t==='neon'); }
let theme = localStorage.getItem('theme') || 'dark';
applyTheme(theme);
themeBtn.onclick = ()=>{ theme = (theme==='neon'?'dark':'neon'); localStorage.setItem('theme', theme); applyTheme(theme); };

/* Użyj mojego układu */
function applyUseBtn(){ setToggle(layoutUseBtn, useCanvasLayout); }
layoutUseBtn.addEventListener('click', ()=>{
  useCanvasLayout = !useCanvasLayout;
  localStorage.setItem(layoutUseKey, useCanvasLayout?'1':'0');
  applyUseBtn();
  // jeśli wychodzimy z edycji, dopilnuj uchwytów
  if(layoutMode) exitLayout(true); else { clearSelectionAndHandles(); renderPads(); }
});

/* Rozmiar */
sizeEl.addEventListener('input',(e)=>{
  const v = Number(e.target.value); const scale = v/100;
  document.documentElement.style.setProperty('--size-min',  Math.round(84*scale)+'px');
  document.documentElement.style.setProperty('--size-vw',   (28*scale)+'vw');
  document.documentElement.style.setProperty('--size-max',  Math.round(160*scale)+'px');
});

/* BPM */
function setBpmDisplay(v){ bpmVal.textContent=String(v); bpmTopVal.textContent=String(v); }
bpmEl.addEventListener('input',(e)=> setBpmDisplay(e.target.value) );
setBpmDisplay(bpmEl.value);

/* Start overlay */
const tapStart=document.getElementById('tapStart');
const tapStartBtn=document.getElementById('tapStartBtn');
['click','touchstart'].forEach(ev=> tapStartBtn.addEventListener(ev,()=>startAudio(),{passive:true}) );

/* Narzędzia */
function clearSelectionAndHandles(){
  document.querySelectorAll('.pad.selected').forEach(p=>p.classList.remove('selected'));
  document.querySelectorAll('.pad .handle').forEach(h=>h.remove());
  editPanel.style.display='none';
  selectedPadEl=null;
}

/* START – respektuj „Użyj mojego układu” już na starcie */
function initialRender(){
  applyUseBtn(); // odśwież stan przycisku
  renderPads();  // jeśli ON → Canvas od razu; jeśli brak pozycji → defaultPositionsForKit
  tapStart.style.display='flex';
}
window.addEventListener('load', initialRender);

/* PWA SW */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
</script>
</body>
</html>
