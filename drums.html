<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Drum Pad</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b0d10">
<style>
:root{
  --bg:#0b0d10; --text:#e6edf3; --muted:#9aa4ad;
  --pad:#1b1f24; --pad-active:#2d333b; --accent:#4aa3ff;
  --topbar-h:52px;
  --size-min:84px; --size-vw:28vw; --size-max:160px;
  --btn-bg:#12161b; --btn-br:#2b3138; --btn-glow:rgba(74,163,255,.35);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-tap-highlight-color:transparent; touch-action:manipulation;}
body,#app{min-height:100svh}

/* Topbar */
.topbar{position:fixed;top:0;left:0;right:0;z-index:90;height:var(--topbar-h);
  display:flex;align-items:center;gap:.6rem;padding:0 .6rem; background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));}
.title{font-weight:800;letter-spacing:.4px;margin-left:.2rem}
.muted{color:var(--muted);font-size:.9rem}
.badge{font-size:.85rem;color:var(--muted);padding:.1rem .4rem;border:1px solid var(--btn-br);border-radius:.5rem;background:#0e1116}

/* Buttons (spójny system + neon) */
.btn, select, input[type="text"]{
  appearance:none;cursor:pointer;font-weight:700;color:var(--text);
  background:var(--btn-bg);border:1px solid var(--btn-br);border-radius:.8rem;
  padding:.5rem .8rem;display:inline-flex;align-items:center;gap:.45rem;
  box-shadow:0 0 0 1px rgba(255,255,255,.02) inset, 0 4px 16px rgba(0,0,0,.32);
}
.btn:active{transform:scale(.98)}
.btn.ghost{background:transparent}
.btn.danger{background:#301919;border-color:#7a2f2f}
.btn.primary{background:#142231;border-color:#356a92}
.btn.toggle{position:relative}
.btn.toggle[data-on="1"]{outline:2px solid var(--accent); box-shadow:0 0 0 3px rgba(74,163,255,.13)}

body.theme-neon{
  --bg:#070910; --text:#e9f6ff; --muted:#9cc7ff;
  --pad:#0b1020; --pad-active:#111a33; --accent:#00e5ff;
  --btn-bg:#0a1121; --btn-br:#123154; --btn-glow:rgba(0,229,255,.45);
}
body.theme-neon .btn, body.theme-neon select, body.theme-neon input[type="text"]{
  box-shadow:0 0 10px var(--btn-glow), 0 8px 24px rgba(0,0,0,.35), inset 0 2px 0 rgba(0,0,0,.55);
  text-shadow:0 0 6px rgba(0,229,255,.25);
}
body.theme-neon .btn.toggle[data-on="1"]{outline:2px solid var(--accent); box-shadow:0 0 14px var(--btn-glow), 0 0 0 3px rgba(0,229,255,.15)}

/* Stage */
#stage{position:fixed; top:calc(var(--topbar-h) + 4px); left:0; right:0; bottom:6px; padding:.8rem; overflow:hidden; touch-action:manipulation;}
.grid{display:grid;gap:.8rem;
  grid-template-columns:repeat(auto-fit,minmax(clamp(var(--size-min), var(--size-vw), var(--size-max)),1fr));
  grid-auto-rows:minmax(clamp(72px,16vh,180px),1fr); align-content:start}
.canvas{position:relative}
.canvas .pad{position:absolute;touch-action:none}

/* Pads (tylko pełne kształty – bez clip-path) */
.pad{
  background:var(--pad);border:1px solid #2b3138;border-radius:2rem; /* bazowo „round” */
  display:flex;align-items:center;justify-content:center;text-align:center;
  padding:.45rem;user-select:none;-webkit-user-select:none;font-weight:800;letter-spacing:.3px;
  box-shadow:0 2px 0 rgba(0,0,0,.5) inset,0 6px 18px rgba(0,0,0,.25);
  touch-action:none;font-size:16px; color:#fff; outline-offset:0;
}
.pad.active{
  background:var(--pad-active);outline:2px solid var(--accent);
  box-shadow:0 0 0 4px rgba(74,163,255,.15),0 10px 28px rgba(0,0,0,.4) inset;
  transform:scale(.99)
}
.pad.dragging{opacity:.95;outline:2px dashed var(--accent)}
.shape-round{border-radius:2rem}
.shape-oval{border-radius:9999px}
.shape-circle{border-radius:9999px}

/* Kolory kategorii (delikatny gradient – bez przycinania) */
.c-kick{background:radial-gradient(120% 120% at 30% 30%,#2a3a20,#1c2416 70%)}
.c-snare{background:radial-gradient(120% 120% at 30% 30%,#2b2e3a,#171a21 70%)}
.c-hats{background:radial-gradient(120% 120% at 30% 30%,#27333d,#151c22 70%)}
.c-toms{background:radial-gradient(120% 120% at 30% 30%,#2d3131,#171a1a 70%)}
.c-cym{background:radial-gradient(120% 120% at 30% 30%,#303227,#181a12 70%)}
.c-hand{background:radial-gradient(120% 120% at 30% 30%,#2a2e38,#151922 70%)}
.c-fun{background:radial-gradient(120% 120% at 30% 30%,#3a2a2a,#211515 70%)}

/* Menu */
#menuPanel{position:fixed;inset:0;z-index:100;display:none;
  background:rgba(0,0,0,.72);backdrop-filter:saturate(1.2) blur(6px);
  padding:64px 14px 14px;color:var(--text)}
.menu-card{margin:0 auto;max-width:720px;background:#0e1116;border:1px solid #2b3138;border-radius:1rem; padding:.9rem}
.menu-section{border-top:1px solid #212832;margin-top:.7rem;padding-top:.7rem}
.menu-row{display:flex;align-items:center;justify-content:space-between;gap:.6rem;flex-wrap:wrap}
.menu-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:.7rem}

/* Layout bar */
#layoutBar{position:fixed;left:50%;transform:translateX(-50%);
  bottom:10px; z-index:95; display:none; gap:.5rem}

/* Start overlay */
#tapStart{position:fixed;inset:0;z-index:120;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;
  padding:2rem;text-align:center;color:var(--text);background:rgba(0,0,0,.86)}
#tapStart .big{font-size:1.25rem;font-weight:800}

/* Edit panel */
#editPanel{position:fixed;left:8px;right:8px;bottom:8px;z-index:96;display:none;
  background:#0b0e14cc;border:1px solid #1f2633;border-radius:1rem;padding:.5rem .6rem;backdrop-filter: blur(6px)}
#editPanel.at-top{top:8px;bottom:auto}
#editPanel .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
.pad.selected{outline:2px solid var(--accent)}
.handle{position:absolute;width:16px;height:16px;background:#fff;border:2px solid #0007;border-radius:50%;box-shadow:0 2px 6px #0008;touch-action:none}
.h-nw{left:-10px;top:-10px;cursor:nwse-resize}
.h-ne{right:-10px;top:-10px;cursor:nesw-resize}
.h-sw{left:-10px;bottom:-10px;cursor:nesw-resize}
.h-se{right:-10px;bottom:-10px;cursor:nwse-resize}
.h-rot{left:50%;top:-36px;transform:translateX(-50%);width:20px;height:20px;cursor:grab}

/* Icon btn */
.iconbtn{appearance:none;cursor:pointer;border:1px solid var(--btn-br);border-radius:.8rem;
  background:var(--btn-bg);color:var(--text);padding:.5rem .8rem;display:flex;align-items:center;gap:.4rem}
.icon{width:18px;height:2px;background:currentColor;position:relative;display:inline-block}
.icon::before,.icon::after{content:"";position:absolute;left:0;right:0;height:2px;background:currentColor}
.icon::before{top:-6px}.icon::after{top:6px}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <button id="menuBtn" class="iconbtn" title="Menu"><span class="icon" aria-hidden="true"></span></button>
    <div class="title">Drum Pad</div>
    <div class="muted">dotknij pad, by grać</div>
    <div style="margin-left:auto" class="badge">BPM: <span id="bpmTopVal">100</span></div>
  </div>

  <div id="tapStart">
    <div class="big">Dotknij, aby rozpocząć</div>
    <button id="tapStartBtn" class="btn primary">Start audio</button>
  </div>

  <div id="stage" class="grid"></div>

  <div id="layoutBar">
    <button id="layoutSave" class="btn primary">Zapisz</button>
    <button id="layoutCancel" class="btn ghost">Anuluj</button>
  </div>

  <div id="menuPanel" aria-hidden="true">
    <div class="menu-card">
      <div class="menu-section"><div class="menu-row"><strong>Ustawienia</strong><span class="badge">wybierz i „OK”</span></div></div>

      <div class="menu-section">
        <div class="menu-row">
          <div>Zestaw</div>
          <div>
            <select id="kitSelect" class="btn"></select>
            <button id="customBtn" class="btn">Własne…</button>
          </div>
        </div>
        <div class="menu-row">
          <div>Układ</div>
          <div>
            <button id="layoutStart" class="btn">START</button>
            <button id="layoutUseBtn" class="btn toggle" data-on="0">Użyj mojego układu</button>
          </div>
        </div>
      </div>

      <div class="menu-section">
        <div class="menu-row">
          <div>Metronom</div>
          <div>
            <button id="metroBtn" class="btn toggle" data-on="0">Metro</button>
            <label class="badge">BPM: <span id="bpmVal">100</span></label>
            <input id="bpm" type="range" min="40" max="220" step="1" value="100">
          </div>
        </div>
        <div class="menu-row">
          <div>Neon</div>
          <div><button id="themeBtn" class="btn toggle" data-on="0">Neon</button></div>
        </div>
        <div class="menu-row">
          <div>Rozmiar padów</div>
          <div><input id="size" type="range" min="80" max="130" step="1" value="100"></div>
        </div>
        <div class="menu-row">
          <div>Głośność</div>
          <div><input id="volume" type="range" min="0" max="1" step="0.01" value="0.9"></div>
        </div>
      </div>

      <div class="menu-actions">
        <button id="menuCancel" class="btn ghost">Anuluj</button>
        <button id="menuOk" class="btn primary">OK</button>
      </div>
    </div>
  </div>

  <!-- Panel edycji pada (na żądanie: long-press / dblclick) -->
  <div id="editPanel">
    <div class="row">
      <span class="badge">Pad:</span>
      <strong id="epLabel">—</strong>
      <input id="inpLabel" type="text" placeholder="etykieta" class="btn" style="min-width:140px">
      <button id="btnColor" class="btn">Kolor</button>
      <input id="inpColor" type="color" style="display:none">
      <select id="selShape" class="btn">
        <option value="oval">Owal</option>
        <option value="round">Zaokrąglony</option>
        <option value="circle">Okrągły</option>
      </select>
      <button id="btnFront" class="btn">Na wierzch</button>
      <button id="btnBack" class="btn">Na spód</button>
      <button id="btnDup" class="btn">Duplikuj</button>
      <button id="btnDel" class="btn danger">Usuń</button>
    </div>
    <div class="row" style="margin-top:.4rem">
      <span class="badge">Dźwięk:</span>
      <button id="btnSoundFile" class="btn">Plik…</button>
      <input id="inpSoundFile" type="file" accept="audio/*" style="display:none">
      <button id="btnSoundUrl" class="btn">URL…</button>
      <button id="btnClrSound" class="btn ghost">Usuń przypisanie</button>
    </div>
    <div class="row" style="margin-top:.4rem">
      <button id="btnEPOk" class="btn primary">OK</button>
    </div>
  </div>
</div>

<script>
/* === AUDIO CORE === */
let ctx=null, master=null, volumeNode=null, started=false;
const vol=document.getElementById('volume');
function initAudio(){ if(ctx) return;
  const AC=window.AudioContext||window.webkitAudioContext;
  ctx=new AC({latencyHint:'interactive'});
  master=ctx.createGain(); volumeNode=ctx.createGain();
  master.connect(volumeNode).connect(ctx.destination);
  volumeNode.gain.value=parseFloat(vol.value);
  const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master); o.start(); o.stop(ctx.currentTime+0.02);
}
async function ensureRunning(){ if(!ctx) initAudio(); if(ctx.state!=='running'){ try{ await ctx.resume(); }catch{} } }
async function startAudio(){ initAudio(); await ensureRunning(); started=true; tapStart.style.display='none'; }
const now=()=>ctx?ctx.currentTime:0;
function noiseBuffer(){ const len=Math.floor(ctx.sampleRate*2.0), b=ctx.createBuffer(1,len,ctx.sampleRate), d=b.getChannelData(0); for(let i=0;i<len;i++) d[i]=Math.random()*2-1; return b; }
const sharedNoise=(()=>{let _b=null;return()=>_b||(_b=noiseBuffer())})();

/* === SYNTHS === */
const S={
  kick:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(160,t); o.frequency.exponentialRampToValueAtTime(40,t+.14); g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(1,t+.01); g.gain.exponentialRampToValueAtTime(0.001,t+.18); o.connect(g).connect(master); o.start(t); o.stop(t+.25); },
  snare:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200; const g=ctx.createGain(); g.gain.value=.6; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.12); },
  hatClosed:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000; const g=ctx.createGain(); g.gain.value=.35; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.06); },
  hatOpen:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; const g=ctx.createGain(); g.gain.value=.3; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.25); },
  tomLow:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(130,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.9,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.4); o.connect(g).connect(master); o.start(t); o.stop(t+.5); },
  tomHigh:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(190,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.9,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.3); o.connect(g).connect(master); o.start(t); o.stop(t+.4); },
  clap:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const g=ctx.createGain(); g.gain.value=.6; src.connect(g).connect(master); src.start(t); src.stop(t+.1); },
  crash:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000; const g=ctx.createGain(); g.gain.value=.4; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.7); },
  ride:(t=now())=>{ const src=ctx.createBufferSource(); src.buffer=sharedNoise(); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3500; const g=ctx.createGain(); g.gain.value=.25; src.connect(hp).connect(g).connect(master); src.start(t); src.stop(t+.6); },
  rim:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(900,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.7,t+.005); g.gain.exponentialRampToValueAtTime(.0001,t+.08); o.connect(g).connect(master); o.start(t); o.stop(t+.1); },
  perc:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(400,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.8,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.12); o.connect(g).connect(master); o.start(t); o.stop(t+.18); },
  kick808:(t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(80,t); o.frequency.exponentialRampToValueAtTime(38,t+.28); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(1,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.6); o.connect(g).connect(master); o.start(t); o.stop(t+.75); },
  handpanNote:(freq=220,t=now())=>{ const o=ctx.createOscillator(); const g=ctx.createGain(); const f=ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=freq; f.Q.value=8;
    o.type='sine'; o.frequency.setValueAtTime(freq,t); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.9,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.9);
    o.connect(f).connect(g).connect(master); o.start(t); o.stop(t+1.0); }
};
const HAND={hand1:146.83,hand2:220.00,hand3:261.63,hand4:293.66,hand5:329.63,hand6:349.23,hand7:392.00,hand8:440.00,hand9:523.25};

/* === Kits === */
const KITS={
  "Standard": ['kick808','snare','hatClosed','hatOpen','tomLow','tomHigh','clap','crash','ride','rim','perc','kick'],
  "Handpan":  ['hand1','hand2','hand3','hand4','hand5','hand6','hand7','hand8','hand9']
};
/* Kształt klasy: tylko round / oval / circle */
function shapeClass(id){
  if(/^hand\d$/.test(id)) return 'shape-oval';
  if(id==='crash' || id==='ride' || id==='hatClosed' || id==='hatOpen') return 'shape-circle';
  return 'shape-round';
}
function colorClass(id){
  if(['kick','kick808'].includes(id)) return 'c-kick';
  if(['snare','clap'].includes(id)) return 'c-snare';
  if(['hatClosed','hatOpen'].includes(id)) return 'c-hats';
  if(['tomHigh','tomLow'].includes(id)) return 'c-toms';
  if(['crash','ride'].includes(id)) return 'c-cym';
  if(/^hand\d$/.test(id)) return 'c-hand';
  return 'c-fun';
}

/* === UI refs === */
const stage=document.getElementById('stage');
const menuBtn=document.getElementById('menuBtn');
const menuPanel=document.getElementById('menuPanel');
const menuOk=document.getElementById('menuOk');
const menuCancel=document.getElementById('menuCancel');
const kitSelect=document.getElementById('kitSelect');
const layoutStart=document.getElementById('layoutStart');
const layoutUseBtn=document.getElementById('layoutUseBtn');
const sizeEl=document.getElementById('size');
const themeBtn=document.getElementById('themeBtn');
const bpmEl=document.getElementById('bpm');
const bpmVal=document.getElementById('bpmVal');
const bpmTopVal=document.getElementById('bpmTopVal');
const tapStart=document.getElementById('tapStart');
const tapStartBtn=document.getElementById('tapStartBtn');

/* === State === */
let currentKit=localStorage.getItem('kitName')||'Standard';
let layoutMode=false;
const positionsKey=()=> 'padPositions:'+currentKit;
const layoutUseKey='useCanvasLayout';
let useCanvasLayout = localStorage.getItem(layoutUseKey)==='1';
let draftPositions=null;
let selectedPadEl=null;

function getSavedPositions(){ return JSON.parse(localStorage.getItem(positionsKey())||'{}'); }
function setSavedPositions(obj){ localStorage.setItem(positionsKey(), JSON.stringify(obj||{})); }

/* Domyślny Canvas rozkład (%) gdy brak zapisanych */
function defaultPositionsForKit(list){
  const out={};
  const cols=3, rows=Math.ceil(list.length/cols);
  const cellW= (100-8)/cols, cellH= (100-8)/Math.max(rows,2);
  list.forEach((id,i)=>{
    const c=i%cols, r=Math.floor(i/cols);
    out[id]={left:2 + c*cellW, top:2 + r*cellH, w:cellW-2, h:cellH-4, rot:0, label:id.toUpperCase(), color:null, z:i+1, shape: shapeClass(id), sound:null};
  });
  return out;
}

function setToggle(btn,on){ btn.dataset.on = on?'1':'0'; }
function applyUseBtn(){ setToggle(layoutUseBtn, useCanvasLayout); }
function applyTheme(t){ document.body.classList.toggle('theme-neon', t==='neon'); setToggle(themeBtn, t==='neon'); }
let theme = localStorage.getItem('theme') || 'dark'; applyTheme(theme);
themeBtn.onclick = ()=>{ theme=(theme==='neon'?'dark':'neon'); localStorage.setItem('theme',theme); applyTheme(theme); };

function setBpmDisplay(v){ bpmVal.textContent=String(v); bpmTopVal.textContent=String(v); }
bpmEl.addEventListener('input',(e)=> setBpmDisplay(e.target.value) );
setBpmDisplay(bpmEl.value);

/* Render */
function renderPads(){
  const list = (KITS[currentKit]||[]).slice(0,12);
  const saved = getSavedPositions();
  const playCanvas = (!layoutMode && useCanvasLayout) || layoutMode;
  stage.className = playCanvas ? 'canvas' : 'grid';
  stage.innerHTML='';

  const P = layoutMode ? (draftPositions||{}) : (Object.keys(saved).length? saved : defaultPositionsForKit(list));

  if(!playCanvas){
    list.forEach(id=>{
      const el=document.createElement('div');
      el.className=`pad ${shapeClass(id)} ${colorClass(id)}`;
      el.dataset.sound=id;
      el.textContent=(saved[id]?.label)||id.toUpperCase();
      stage.appendChild(el);
    });
  }else{
    list.forEach((id,idx)=>{
      const def = defaultPositionsForKit([id])[id];
      const cfg = P[id] ? {...def, ...P[id]} : def;
      const el=document.createElement('div');
      el.className=`pad ${cfg.shape||shapeClass(id)} ${colorClass(id)}`;
      el.dataset.sound=id;
      el.style.left=(cfg.left??2)+'%';
      el.style.top=(cfg.top??2)+'%';
      el.style.width=(cfg.w??30)+'%';
      el.style.height=(cfg.h??18)+'%';
      el.style.transform=`rotate(${cfg.rot||0}deg)`;
      el.style.zIndex=String(cfg.z||1);
      if(cfg.color) el.style.background=cfg.color;
      el.textContent=(cfg.label)||id.toUpperCase();

      if(layoutMode){
        // zaznaczanie + drag/scale/rotate
        el.addEventListener('pointerdown',(e)=>selectPad(el,e));
        addHandles(el);
        makeDraggable(el);

        // WYWOŁANIE PANELU: dblclick lub long-press (~500ms)
        el.addEventListener('dblclick', ()=>{ selectPad(el); showEditPanel(el); });
        let lpTimer=null;
        const lpStart=()=>{ clearTimeout(lpTimer); lpTimer=setTimeout(()=>{ selectPad(el); showEditPanel(el); },500); };
        const lpCancel=()=>{ clearTimeout(lpTimer); };
        el.addEventListener('pointerdown', lpStart);
        el.addEventListener('pointerup', lpCancel);
        el.addEventListener('pointercancel', lpCancel);
        el.addEventListener('pointermove', lpCancel);
      }else{
        el.addEventListener('pointerdown',(e)=>{ e.preventDefault(); padDown(el,cfg); },{passive:false});
        el.addEventListener('touchstart',()=> padDown(el,cfg),{passive:true});
      }
      stage.appendChild(el);
    });
  }

  layoutBar.style.display = layoutMode ? 'flex' : 'none';
  document.getElementById('editPanel').style.display = (layoutMode && editPanelVisible)?'block':'none';
  if(!layoutMode) clearSelectionAndHandles();
}

/* Play */
async function padDown(el,cfg){
  if(!ctx) initAudio();
  if(!started || (ctx && ctx.state!=='running')) await startAudio();
  const id = el.dataset.sound;

  // Priorytet: przypisany dźwięk → synth/handpan
  const sound = cfg?.sound || getSavedPositions()[id]?.sound || null;
  if(sound){
    try{
      if(sound.type==='dataurl' || sound.type==='url'){
        const resp = await fetch(sound.src, {mode:'cors'}); const arr = await resp.arrayBuffer();
        const buf = await (ctx.decodeAudioData(arr.slice(0)));
        const src = ctx.createBufferSource(); src.buffer = buf; const g=ctx.createGain(); g.gain.value=1.0; src.connect(g).connect(master); src.start();
      }
    }catch(e){ console.warn('Audio URL error',e); }
  }else{
    if(HAND[id]){ S.handpanNote(HAND[id]); } else { S[id]?.(); }
  }

  el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),120);
}

/* Layout mode */
const layoutBar=document.getElementById('layoutBar');
const layoutSave=document.getElementById('layoutSave');
const layoutCancel=document.getElementById('layoutCancel');

function enterLayout(){ layoutMode=true; draftPositions = structuredClone(getSavedPositions()); selectedPadEl=null; renderPads(); }
function exitLayout(save){ if(save){ setSavedPositions(draftPositions); } layoutMode=false; draftPositions=null; selectedPadEl=null; hideEditPanel(); clearSelectionAndHandles(); renderPads(); }
layoutSave.onclick = ()=> exitLayout(true);
layoutCancel.onclick = ()=> exitLayout(false);

/* Drag/Scale/Rotate */
function stageRect(){ return stage.getBoundingClientRect(); }
function getRotationFromTransform(tr){ const m=/rotate\(([-\d.]+)deg\)/.exec(tr||''); return m?parseFloat(m[1]):0; }
function clampPc(v){ return Math.min(98, Math.max(2, v)); }

function makeDraggable(el){
  let sx=0,sy=0,sl=0,st=0,drag=false;
  const down=(ev)=>{ if(!layoutMode) return;
    drag=true; el.classList.add('dragging');
    const R=stageRect(), P=el.getBoundingClientRect();
    sl=((P.left-R.left)/R.width)*100; st=((P.top-R.top)/R.height)*100;
    sx=ev.clientX||(ev.touches&&ev.touches[0].clientX); sy=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    addEventListener('pointermove',move); addEventListener('pointerup',up,{once:true});
    addEventListener('touchmove',move,{passive:false}); addEventListener('touchend',up,{once:true});
  };
  const move=(ev)=>{ if(!drag) return; ev.preventDefault?.();
    const x=ev.clientX||(ev.touches&&ev.touches[0].clientX), y=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    const R=stageRect(); const dx=((x-sx)/R.width)*100, dy=((y-sy)/R.height)*100;
    el.style.left=clampPc(sl+dx)+'%'; el.style.top=clampPc(st+dy)+'%';
    updateEditPanelFromEl(el,true);
  };
  const up=()=>{ drag=false; el.classList.remove('dragging');
    removeEventListener('pointermove',move); removeEventListener('touchmove',move);
    savePadRect(el);
  };
  el.addEventListener('pointerdown',down); el.addEventListener('touchstart',down,{passive:true});
}

function addHandles(el){
  el.querySelectorAll('.handle').forEach(h=>h.remove());
  ['nw','ne','sw','se','rot'].forEach(pos=>{
    const h=document.createElement('div'); h.className='handle h-'+pos; el.appendChild(h);
    h.addEventListener('pointerdown',(e)=>startTransform(e, el, pos));
    h.addEventListener('touchstart',(e)=>startTransform(e, el, pos),{passive:true});
  });
}
function startTransform(e, el, type){
  if(!layoutMode) return; e.preventDefault?.();
  const R=stageRect(), P=el.getBoundingClientRect();
  const start={ l:((P.left-R.left)/R.width)*100, t:((P.top-R.top)/R.height)*100, w:(P.width/R.width)*100, h:(P.height/R.height)*100, rot:getRotationFromTransform(el.style.transform)||0 };
  const sx=e.clientX||(e.touches&&e.touches[0].clientX); const sy=e.clientY||(e.touches&&e.touches[0].clientY);
  const move=(ev)=>{
    const x=ev.clientX||(ev.touches&&ev.touches[0].clientX), y=ev.clientY||(ev.touches&&ev.touches[0].clientY);
    const dx=((x-sx)/R.width)*100, dy=((y-sy)/R.height)*100;
    if(type==='rot'){
      const b=el.getBoundingClientRect(); const cx=(b.left-R.left)+b.width/2, cy=(b.top-R.top)+b.height/2;
      const ang=Math.atan2((y-(R.top+cy)),(x-(R.left+cx))); const deg=Math.round((ang*180/Math.PI+90));
      el.style.transform=`rotate(${deg}deg)`;
    }else{
      let l=start.l, t=start.t, w=start.w, h=start.h;
      if(type==='se'){ w=clampPc(start.w+dx); h=clampPc(start.h+dy); }
      if(type==='ne'){ w=clampPc(start.w+dx); h=clampPc(start.h-dy); t=clampPc(start.t+dy); }
      if(type==='sw'){ w=clampPc(start.w-dx); h=clampPc(start.h+dy); l=clampPc(start.l+dx); }
      if(type==='nw'){ w=clampPc(start.w-dx); h=clampPc(start.h-dy); l=clampPc(start.l+dx); t=clampPc(start.t+dy); }
      el.style.left=l+'%'; el.style.top=t+'%'; el.style.width=w+'%'; el.style.height=h+'%';
    }
    updateEditPanelFromEl(el,true);
  };
  const up=()=>{ removeEventListener('pointermove',move); removeEventListener('pointerup',up);
    removeEventListener('touchmove',move); removeEventListener('touchend',up); savePadRect(el); };
  addEventListener('pointermove',move); addEventListener('pointerup',up,{once:true});
  addEventListener('touchmove',move,{passive:false}); addEventListener('touchend',up,{once:true});
}

function savePadRect(el){
  if(!draftPositions) draftPositions={};
  const id=el.dataset.sound; const R=stageRect(), P=el.getBoundingClientRect();
  draftPositions[id] = Object.assign(draftPositions[id]||{}, {
    left:((P.left-R.left)/R.width)*100, top:((P.top-R.top)/R.height)*100,
    w:(P.width/R.width)*100, h:(P.height/R.height)*100,
    rot:getRotationFromTransform(el.style.transform)||0,
    label: el.textContent.trim(),
    color: el.style.background||null,
    shape: [...el.classList].find(c=>c.startsWith('shape-'))?.replace('shape-','') || 'round',
    z: parseInt(el.style.zIndex||'1',10)
  });
}

/* Edit panel — na żądanie */
const editPanel=document.getElementById('editPanel');
const epLabel=document.getElementById('epLabel');
const inpLabel=document.getElementById('inpLabel');
const btnColor=document.getElementById('btnColor');
const inpColor=document.getElementById('inpColor');
const selShape=document.getElementById('selShape');
const btnFront=document.getElementById('btnFront');
const btnBack=document.getElementById('btnBack');
const btnDup=document.getElementById('btnDup');
const btnDel=document.getElementById('btnDel');
const btnSoundFile=document.getElementById('btnSoundFile');
const inpSoundFile=document.getElementById('inpSoundFile');
const btnSoundUrl=document.getElementById('btnSoundUrl');
const btnClrSound=document.getElementById('btnClrSound');
const btnEPOk=document.getElementById('btnEPOk');

let editPanelVisible=false;

function showEditPanel(anchorEl){
  editPanelVisible = true;
  editPanel.style.display = 'block';
  // auto-pozycja (góra/dół) – żeby nie zasłaniać dolnych padów
  if(anchorEl){
    const R = stage.getBoundingClientRect();
    const P = anchorEl.getBoundingClientRect();
    const padBottomPct = ((P.bottom - R.top) / R.height) * 100;
    if(padBottomPct > 65){ editPanel.classList.add('at-top'); }
    else { editPanel.classList.remove('at-top'); }
  }
}
function hideEditPanel(){ editPanelVisible=false; editPanel.style.display='none'; }
function toggleEditPanel(anchorEl){ if(editPanelVisible) hideEditPanel(); else showEditPanel(anchorEl); }

function updateEditPanelFromEl(el,live=false){
  if(!layoutMode || !el){ return; }
  const id = el.dataset.sound;
  epLabel.textContent = id;
  if(!live){
    inpLabel.value = el.textContent.trim();
    const shape = [...el.classList].find(c=>c.startsWith('shape-'))?.replace('shape-','') || 'round';
    selShape.value = shape==='round'?'round':(shape==='circle'?'circle':'oval');
    const c=(el.style.background||'').trim(); if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)) inpColor.value=c;
  }
}
function selectPad(el,e){ e?.preventDefault?.(); selectedPadEl=el;
  document.querySelectorAll('.pad').forEach(p=>p.classList.toggle('selected', p===el));
  updateEditPanelFromEl(el); /* nie pokazujemy panelu automatycznie */
}
function clearSelectionAndHandles(){ document.querySelectorAll('.pad.selected').forEach(p=>p.classList.remove('selected'));
  document.querySelectorAll('.pad .handle').forEach(h=>h.remove()); hideEditPanel(); selectedPadEl=null; }

btnEPOk.addEventListener('click', ()=> hideEditPanel());

/* Edytowalne właściwości */
function currentCfgId(){ return selectedPadEl?.dataset.sound; }
inpLabel.addEventListener('input', ()=>{
  if(!selectedPadEl) return;
  selectedPadEl.textContent = inpLabel.value.trim() || selectedPadEl.dataset.sound.toUpperCase();
  savePadRect(selectedPadEl);
});
btnColor.addEventListener('click', ()=> inpColor.click());
inpColor.addEventListener('input', ()=>{
  if(!selectedPadEl) return;
  selectedPadEl.style.background = inpColor.value; savePadRect(selectedPadEl);
});
selShape.addEventListener('change', ()=>{
  if(!selectedPadEl) return;
  ['shape-round','shape-oval','shape-circle'].forEach(c=>selectedPadEl.classList.remove(c));
  selectedPadEl.classList.add('shape-'+selShape.value);
  savePadRect(selectedPadEl);
});
btnFront.addEventListener('click', ()=>{
  if(!selectedPadEl) return; selectedPadEl.style.zIndex=String(Date.now()%2147483647); savePadRect(selectedPadEl);
});
btnBack.addEventListener('click', ()=>{
  if(!selectedPadEl) return; selectedPadEl.style.zIndex='1'; savePadRect(selectedPadEl);
});
btnDup.addEventListener('click', ()=>{
  if(!selectedPadEl) return;
  const R=stageRect(), P=selectedPadEl.getBoundingClientRect();
  const ghost=selectedPadEl.cloneNode(true);
  ghost.style.left=(((P.left-R.left)/R.width)*100+4)+'%';
  ghost.style.top =(((P.top -R.top )/R.height)*100+4)+'%';
  ghost.style.zIndex=String(Date.now()%2147483647);
  stage.appendChild(ghost); addHandles(ghost); makeDraggable(ghost);
});
btnDel.addEventListener('click', ()=>{
  if(!selectedPadEl) return;
  const id = selectedPadEl.dataset.sound; selectedPadEl.remove();
  if(draftPositions && draftPositions[id]) delete draftPositions[id];
  selectedPadEl=null;
});

/* Przypisywanie dźwięku: Plik/URL/Usuń (zapis w draftPositions[id].sound) */
btnSoundFile.addEventListener('click', ()=> inpSoundFile.click());
inpSoundFile.addEventListener('change', async ()=>{
  if(!selectedPadEl || !inpSoundFile.files[0]) return;
  const f = inpSoundFile.files[0]; const data = await f.arrayBuffer();
  const b64 = await new Promise((res)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(new Blob([data])); });
  applyPadSound({type:'dataurl', src:String(b64)});
  inpSoundFile.value='';
  alert('Dźwięk z pliku przypisany. Zapisz układ, aby zachować.');
});
btnSoundUrl.addEventListener('click', ()=>{
  if(!selectedPadEl) return;
  const url = prompt('Wklej URL do pliku audio:\n(np. https://raw.githubusercontent.com/<user>/<repo>/main/sounds/kick.wav)');
  if(!url) return;
  applyPadSound({type:'url', src:url.trim()});
  alert('Dźwięk z URL przypisany. Zapisz układ, aby zachować.');
});
btnClrSound.addEventListener('click', ()=>{
  const id=currentCfgId(); if(!id||!draftPositions) return;
  if(!draftPositions[id]) draftPositions[id]={};
  draftPositions[id].sound=null; alert('Usunięto przypisanie dźwięku. Zapisz układ, aby zachować.');
});
function applyPadSound(obj){
  const id=currentCfgId(); if(!id) return;
  if(!draftPositions) draftPositions={};
  if(!draftPositions[id]) draftPositions[id]={};
  draftPositions[id].sound=obj;
}

/* Menu */
function fillKits(){ kitSelect.innerHTML=''; Object.keys(KITS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; if(k===currentKit) o.selected=true; kitSelect.appendChild(o); }); }
function openMenu(){ fillKits(); applyUseBtn(); menuPanel.style.display='block'; }
function closeMenu(){ menuPanel.style.display='none'; }
menuBtn.onclick=openMenu;
menuCancel.onclick=()=>{ closeMenu(); clearSelectionAndHandles(); renderPads(); };
menuOk.onclick=()=>{
  const chosen=kitSelect.value; if(chosen && chosen!==currentKit){ currentKit=chosen; localStorage.setItem('kitName',currentKit); }
  if(layoutMode) exitLayout(true); else { clearSelectionAndHandles(); renderPads(); }
  closeMenu();
};
layoutStart.onclick=()=>{ closeMenu(); enterLayout(); };
layoutUseBtn.addEventListener('click', ()=>{
  useCanvasLayout=!useCanvasLayout; localStorage.setItem(layoutUseKey, useCanvasLayout?'1':'0'); applyUseBtn();
  if(layoutMode) exitLayout(true); else { clearSelectionAndHandles(); renderPads(); }
});

/* Size & Volume */
sizeEl.addEventListener('input',(e)=>{
  const v = Number(e.target.value); const scale=v/100;
  document.documentElement.style.setProperty('--size-min',  Math.round(84*scale)+'px');
  document.documentElement.style.setProperty('--size-vw',   (28*scale)+'vw');
  document.documentElement.style.setProperty('--size-max',  Math.round(160*scale)+'px');
});
vol.addEventListener('input',()=>{ if(!volumeNode) return; volumeNode.gain.value=parseFloat(vol.value); });

/* BPM label (góra i w menu zsynchronizowane) */
bpmEl.addEventListener('input', (e)=> setBpmDisplay(e.target.value) );

/* Start overlay */
['click','touchstart'].forEach(ev=> tapStartBtn.addEventListener(ev,()=>startAudio(),{passive:true}) );

/* Init */
function initialRender(){ applyUseBtn(); renderPads(); tapStart.style.display='flex'; }
window.addEventListener('load', initialRender);
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') ensureRunning(); });

/* Service Worker */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
</script>
</body>
</html>
